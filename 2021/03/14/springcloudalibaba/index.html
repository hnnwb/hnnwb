<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>springCloudAlibaba | WB</title><meta name="keywords" content="springCloudAlibaba"><meta name="author" content="WB"><meta name="copyright" content="WB"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="第一章 微服务介绍1.1  系统架构演变​    随着互联网的发展，网站应用的规模也在不断的扩大，进而导致系统架构也在不断的进行变化。  从互联网早起到现在，系统架构大体经历了下面几个过程: 单体应用架构—&gt;垂直应用架构—&gt;分布式架构—&gt;SOA架构—&gt;微服务架构，当然还有悄然兴起的Service Mesh(服务网格化)。接下来我们就来了解一下每种系统架构是什么样子的， 以及">
<meta property="og:type" content="article">
<meta property="og:title" content="springCloudAlibaba">
<meta property="og:url" content="https://hnnwb.github.io/2021/03/14/springcloudalibaba/index.html">
<meta property="og:site_name" content="WB">
<meta property="og:description" content="第一章 微服务介绍1.1  系统架构演变​    随着互联网的发展，网站应用的规模也在不断的扩大，进而导致系统架构也在不断的进行变化。  从互联网早起到现在，系统架构大体经历了下面几个过程: 单体应用架构—&gt;垂直应用架构—&gt;分布式架构—&gt;SOA架构—&gt;微服务架构，当然还有悄然兴起的Service Mesh(服务网格化)。接下来我们就来了解一下每种系统架构是什么样子的， 以及">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hnnwb/wbImgs/images/2fa30787e950352a94bda0385f43fbf2b3118bf6.jpg">
<meta property="article:published_time" content="2021-03-14T07:51:08.000Z">
<meta property="article:modified_time" content="2022-01-16T07:12:17.028Z">
<meta property="article:author" content="WB">
<meta property="article:tag" content="springCloudAlibaba">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hnnwb/wbImgs/images/2fa30787e950352a94bda0385f43fbf2b3118bf6.jpg"><link rel="shortcut icon" href="/myimg/favicon.png"><link rel="canonical" href="https://hnnwb.github.io/2021/03/14/springcloudalibaba/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: WB","link":"链接: ","source":"来源: WB","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'springCloudAlibaba',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-01-16 15:12:17'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    document.addEventListener('pjax:complete', detectApple)})(window)</script><link rel="stylesheet" href="//at.alicdn.com/t/font_2322738_q0ve0550p0h.css"><style type="text/css">#toggle-sidebar {bottom: 80px}</style><meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="WB" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/myimg/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 竹简</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-address-book"></i><span> 书单</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-image"></i><span> 照片</span></a></li><li><a class="site-page child" href="/xinqing/"><i class="fa-fw fas fa-heartbeat"></i><span> 心情</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/hnnwb/wbImgs/images/2fa30787e950352a94bda0385f43fbf2b3118bf6.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">WB</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 竹简</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-address-book"></i><span> 书单</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-image"></i><span> 照片</span></a></li><li><a class="site-page child" href="/xinqing/"><i class="fa-fw fas fa-heartbeat"></i><span> 心情</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">springCloudAlibaba</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-03-14T07:51:08.000Z" title="发表于 2021-03-14 15:51:08">2021-03-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-01-16T07:12:17.028Z" title="更新于 2022-01-16 15:12:17">2022-01-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/springCloud/">springCloud</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">25.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>97分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="springCloudAlibaba"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="第一章-微服务介绍"><a href="#第一章-微服务介绍" class="headerlink" title="第一章 微服务介绍"></a>第一章 微服务介绍</h1><h2 id="1-1-系统架构演变"><a href="#1-1-系统架构演变" class="headerlink" title="1.1  系统架构演变"></a>1.1  系统架构演变</h2><p>​    随着互联网的发展，网站应用的规模也在不断的扩大，进而导致系统架构也在不断的进行变化。  从互联网早起到现在，系统架构大体经历了下面几个过程: 单体应用架构—&gt;垂直应用架构—&gt;分布式架构—&gt;SOA架构—&gt;微服务架构，当然还有悄然兴起的Service Mesh(服务网格化)。接下来我们就来了解一下每种系统架构是什么样子的， 以及各有什么优缺点。</p>
<h3 id="1-1-1-单体应用架构"><a href="#1-1-1-单体应用架构" class="headerlink" title="1.1.1  单体应用架构"></a>1.1.1  单体应用架构</h3><p>​    互联网早期，一般的网站应用流量较小，只需一个应用，将所有功能代码都部署在一起就可以，这 样可以减少开发、部署和维护的成本。</p>
<p>​    比如说一个电商系统，里面会包含很多用户管理，商品管理，订单管理，物流管理等等很多模块， 我们会把它们做成一个web项目，然后部署到一台tomcat服务器上。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314161333.png" alt="image-20210314161333586"></p>
<h4 id="优点："><a href="#优点：" class="headerlink" title="优点："></a>优点：</h4><ul>
<li>项目架构简单，小型项目的话， 开发成本低</li>
<li>项目部署在一个节点上， 维护方便</li>
</ul>
<h4 id="缺点："><a href="#缺点：" class="headerlink" title="缺点："></a>缺点：</h4><ul>
<li>全部功能集成在一个工程中，对于大型项目来讲不易开发和维护</li>
<li>项目模块之间紧密耦合，单点容错率低</li>
<li>无法针对不同模块进行针对性优化和水平扩展</li>
</ul>
<h3 id="1-1-2-垂直应用架构"><a href="#1-1-2-垂直应用架构" class="headerlink" title="1.1.2  垂直应用架构"></a>1.1.2  垂直应用架构</h3><p>​    随着访问量的逐渐增大，单一应用只能依靠增加节点来应对，但是这时候会发现并不是所有的模块 都会有比较大的访问量.</p>
<p>​    还是以上面的电商为例子， 用户访问量的增加可能影响的只是用户和订单模块， 但是对消息模块的影响就比较小. 那么此时我们希望只多增加几个订单模块， 而不增加消息模块. 此时单体应用就做不到了， 垂直应用就应运而生了.</p>
<p>​    所谓的垂直应用架构，就是将原来的一个应用拆成互不相干的几个应用，以提升效率。比如我们可 以将上面电商的单体应用拆分成:</p>
<ul>
<li>电商系统(用户管理 商品管理 订单管理)</li>
<li>后台系统(用户管理 订单管理 客户管理)</li>
<li>CMS系统(广告管理 营销管理)</li>
</ul>
<p>这样拆分完毕之后，一旦用户访问量变大，只需要增加电商系统的节点就可以了，而无需增加后台 和CMS的节点。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314162050.png" alt="image-20210314162050443"></p>
<h4 id="优点：-1"><a href="#优点：-1" class="headerlink" title="优点："></a>优点：</h4><ul>
<li>系统拆分实现了流量分担，解决了并发问题，而且可以针对不同模块进行优化和水平扩展</li>
<li>一个系统的问题不会影响到其他系统，提高容错率</li>
</ul>
<h4 id="缺点：-1"><a href="#缺点：-1" class="headerlink" title="缺点："></a>缺点：</h4><ul>
<li>系统之间相互独立， 无法进行相互调用</li>
<li>系统之间相互独立， 会有重复的开发任务</li>
</ul>
<h3 id="1-1-3-分布式架构"><a href="#1-1-3-分布式架构" class="headerlink" title="1.1.3  分布式架构"></a>1.1.3  分布式架构</h3><p>当垂直应用越来越多，重复的业务代码就会越来越多。这时候，我们就思考可不可以将重复的代码 抽取出来，做成统一的业务层作为独立的服务，然后由前端控制层调用不同的业务层服务呢？</p>
<p> 这就产生了新的分布式系统架构。它将把工程拆分成表现层和服务层两个部分，服务层中包含业务 逻辑。表现层只需要处理和页面的交互，业务逻辑都是调用服务层的服务来实现。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314163302.png" alt="image-20210314163302580"></p>
<h4 id="优点：-2"><a href="#优点：-2" class="headerlink" title="优点："></a>优点：</h4><ul>
<li>抽取公共的功能为服务层，提高代码复用性</li>
</ul>
<h4 id="缺点：-2"><a href="#缺点：-2" class="headerlink" title="缺点："></a>缺点：</h4><ul>
<li>系统间耦合度变高，调用关系错综复杂，难以维护</li>
</ul>
<h3 id="1-1-4-SOA架构"><a href="#1-1-4-SOA架构" class="headerlink" title="1.1.4  SOA架构"></a>1.1.4  SOA架构</h3><p>在分布式架构下，当服务越来越多，容量的评估，小服务资源的浪费等问题逐渐显现，此时需增加 一个调度中心对集群进行实时管理。此时，用于资源调度和治理中心(SOA Service Oriented Architecture，面向服务的架构)是关键。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314163455.png" alt="image-20210314163455353"></p>
<h4 id="优点：-3"><a href="#优点：-3" class="headerlink" title="优点："></a>优点：</h4><ul>
<li>使用注册中心解决了服务间调用关系的自动调节</li>
</ul>
<h4 id="缺点：-3"><a href="#缺点：-3" class="headerlink" title="缺点："></a>缺点：</h4><ul>
<li>服务间会有依赖关系，一旦某个环节出错会影响较大( 服务雪崩 )</li>
<li>服务关系复杂，运维、测试部署困难</li>
</ul>
<h3 id="1-1-5-微服务架构"><a href="#1-1-5-微服务架构" class="headerlink" title="1.1.5 微服务架构"></a>1.1.5 微服务架构</h3><p>微服务架构在某种程度上是面向服务的架构SOA继续发展的下一步，它更加强调服务的”彻底拆分”。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314163623.png" alt="image-20210314163623612"></p>
<h4 id="优点：-4"><a href="#优点：-4" class="headerlink" title="优点："></a>优点：</h4><ul>
<li>服务原子化拆分，独立打包、部署和升级，保证每个微服务清晰的任务划分，利于扩展</li>
<li>微服务之间采用Restful等轻量级http协议相互调用</li>
</ul>
<h4 id="缺点：-4"><a href="#缺点：-4" class="headerlink" title="缺点："></a>缺点：</h4><ul>
<li>分布式系统开发的技术成本高（容错、分布式事务等）</li>
</ul>
<h2 id="1-2-微服务架构介绍"><a href="#1-2-微服务架构介绍" class="headerlink" title="1.2  微服务架构介绍"></a>1.2  微服务架构介绍</h2><p>微服务架构， 简单的说就是将单体应用进一步拆分，拆分成更小的服务，每个服务都是一个可以独立运行的项目。</p>
<h3 id="1-2-1-微服务架构的常见问题"><a href="#1-2-1-微服务架构的常见问题" class="headerlink" title="1.2.1  微服务架构的常见问题"></a>1.2.1  微服务架构的常见问题</h3><p>一旦采用微服务系统架构，就势必会遇到这样几个问题：</p>
<ul>
<li>这么多小服务，如何管理他们？(服务治理 注册中心[服务注册 发现 剔除]) </li>
<li>这么多小服务，他们之间如何通讯？(<strong>restful</strong> rpc)</li>
<li>这么多小服务，客户端怎么访问他们？(网关)</li>
<li>这么多小服务，一旦出现问题了，应该如何自处理？(容错) </li>
<li>这么多小服务，一旦出现问题了，应该如何排错? (链路追踪)</li>
</ul>
<p>对于上面的问题，是任何一个微服务设计者都不能绕过去的，因此大部分的微服务产品都针对每一 个问题提供了相应的组件来解决它们。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314163849.png" alt="image-20210314163849136"></p>
<h3 id="1-2-2-微服务架构的常见概念"><a href="#1-2-2-微服务架构的常见概念" class="headerlink" title="1.2.2  微服务架构的常见概念"></a>1.2.2  微服务架构的常见概念</h3><h4 id="1-2-2-1-服务治理"><a href="#1-2-2-1-服务治理" class="headerlink" title="1.2.2.1 服务治理"></a>1.2.2.1 服务治理</h4><p>服务治理就是进行服务的自动化管理，其核心是服务的自动注册与发现。</p>
<p><strong>服务注册</strong>：服务实例将自身服务信息注册到注册中心。</p>
<p><strong>服务发现</strong>：服务实例通过注册中心，获取到注册到其中的服务实例的信息，通过这些信息去请求它们提 供的服务。</p>
<p><strong>服务剔除</strong>：服务注册中心将出问题的服务自动剔除到可用列表之外，使其不会被调用到。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314164129.png" alt="image-20210314164129264"></p>
<h4 id="1-2-2-2-服务调用"><a href="#1-2-2-2-服务调用" class="headerlink" title="1.2.2.2 服务调用"></a>1.2.2.2 服务调用</h4><p>在微服务架构中，通常存在多个服务之间的远程调用的需求。目前主流的远程调用技术有基于</p>
<p>HTTP的RESTful接口以及基于TCP的RPC协议。</p>
<ul>
<li><p><strong>REST</strong>(Representational State Transfer）</p>
<p>这是一种HTTP调用的格式，更标准，更通用，无论哪种语言都支持http协议</p>
</li>
<li><p><strong>RPC</strong>（Remote Promote Call）</p>
<p>一种进程间通信方式。允许像调用本地服务一样调用远程服务。RPC框架的主要目标就是让远程服 务调用更简单、透明。RPC框架负责屏蔽底层的传输方式、序列化方式和通信细节。开发人员在使 用的时候只需要了解谁在什么位置提供了什么样的远程服务接口即可，并不需要关心底层通信细节 和调用过程。</p>
</li>
</ul>
<p><strong>区别与联系</strong></p>
<table>
<thead>
<tr>
<th><strong>比较项</strong></th>
<th><strong>RESTful</strong></th>
<th><strong>RPC</strong></th>
</tr>
</thead>
<tbody><tr>
<td>通讯协议</td>
<td>HTTP</td>
<td>一般使用TCP</td>
</tr>
<tr>
<td>性能</td>
<td>略低</td>
<td>较高</td>
</tr>
<tr>
<td>灵活度</td>
<td>高</td>
<td>低</td>
</tr>
<tr>
<td>应用</td>
<td>微服务架构</td>
<td>SOA架构</td>
</tr>
</tbody></table>
<h4 id="1-2-2-3-服务网关"><a href="#1-2-2-3-服务网关" class="headerlink" title="1.2.2.3 服务网关"></a>1.2.2.3 服务网关</h4><p>随着微服务的不断增多，不同的微服务一般会有不同的网络地址，而外部客户端可能需要调用多个 服务的接口才能完成一个业务需求，如果让客户端直接与各个微服务通信可能出现：</p>
<ul>
<li>客户端需要调用不同的url地址，增加难度</li>
<li>在一定的场景下，存在跨域请求的问题</li>
<li>每个微服务都需要进行单独的身份认证</li>
</ul>
<p>针对这些问题，API网关顺势而生。</p>
<p>API网关直面意思是将所有API调用统一接入到API网关层，由网关层统一接入和输出。一个网关的 基本功能有：统一接入、安全防护、协议适配、流量管控、长短链接支持、容错能力。有了网关之后， 各个API服务提供团队可以专注于自己的的业务逻辑处理，而API网关更专注于安全、流量、路由等问题。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314164405.png" alt="image-20210314164405474"></p>
<h4 id="1-2-2-4-服务容错"><a href="#1-2-2-4-服务容错" class="headerlink" title="1.2.2.4 服务容错"></a>1.2.2.4 服务容错</h4><p>在微服务当中，一个请求经常会涉及到调用几个服务，如果其中某个服务不可用，没有做服务容错 的话，极有可能会造成一连串的服务不可用，这就是雪崩效应。</p>
<p>我们没法预防雪崩效应的发生，只能尽可能去做好容错。服务容错的三个核心思想是：</p>
<ul>
<li>不被外界环境影响</li>
<li>不被上游请求压垮</li>
<li>不被下游响应拖垮</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314164515.png" alt="image-20210314164515852"></p>
<h4 id="1-2-2-5-链路追踪"><a href="#1-2-2-5-链路追踪" class="headerlink" title="1.2.2.5 链路追踪"></a>1.2.2.5 链路追踪</h4><p>随着微服务架构的流行，服务按照不同的维度进行拆分，一次请求往往需要涉及到多个服务。互联 网应用构建在不同的软件模块集上，这些软件模块，有可能是由不同的团队开发、可能使用不同的编程 语言来实现、有可能布在了几千台服务器，横跨多个不同的数据中心。因此，就需要对一次请求涉及的 多个服务链路进行日志记录，性能监控即链路追踪</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314164555.png" alt="image-20210314164555735"></p>
<h3 id="1-2-3-微服务架构的常见解决方"><a href="#1-2-3-微服务架构的常见解决方" class="headerlink" title="1.2.3  微服务架构的常见解决方"></a>1.2.3  微服务架构的常见解决方</h3><h4 id="1-2-3-1-ServiceComb"><a href="#1-2-3-1-ServiceComb" class="headerlink" title="1.2.3.1 ServiceComb"></a>1.2.3.1 ServiceComb</h4><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314164658.png" alt="image-20210314164658342"></p>
<p>Apache ServiceComb，前身是华为云的微服务引擎 CSE (Cloud Service Engine) 云服务，是全球首个Apache微服务顶级项目。它提供了一站式的微服务开源解决方案，致力于帮助企业、用户和开发 者将企业应用轻松微服务化上云，并实现对微服务应用的高效运维管理。</p>
<h4 id="1-2-3-2-SpringCloud"><a href="#1-2-3-2-SpringCloud" class="headerlink" title="1.2.3.2 SpringCloud"></a>1.2.3.2 SpringCloud</h4><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314164730.png" alt="image-20210314164729867"></p>
<p>Spring Cloud是一系列框架的集合。它利用Spring Boot的开发便利性巧妙地简化了分布式系统基础设施的开发，如服务发现注册、配置中心、消息总线、负载均衡、断路器、数据监控等，都可以用Spring Boot的开发风格做到一键启动和部署。</p>
<p>Spring  Cloud并没有重复制造轮子，它只是将目前各家公司开发的比较成熟、经得起实际考验的服务框架组合起来，通过Spring  Boot风格进行再封装屏蔽掉了复杂的配置和实现原理，最终给开发者留出了一套简单易懂、易部署和易维护的分布式系统开发工具包。</p>
<h4 id="1-2-3-3-SpringCloud-Alibaba"><a href="#1-2-3-3-SpringCloud-Alibaba" class="headerlink" title="1.2.3.3 SpringCloud Alibaba"></a>1.2.3.3 SpringCloud Alibaba</h4><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314164809.png" alt="image-20210314164809605"></p>
<p>Spring Cloud Alibaba 致力于提供微服务开发的一站式解决方案。此项目包含开发分布式应用微服务的必需组件，方便开发者通过 Spring Cloud 编程模型轻松使用这些组件来开发分布式应用服务。</p>
<h2 id="1-3-SpringCloud-Alibaba介绍"><a href="#1-3-SpringCloud-Alibaba介绍" class="headerlink" title="1.3  SpringCloud Alibaba介绍"></a>1.3  SpringCloud Alibaba介绍</h2><p>Spring Cloud Alibaba 致力于提供微服务开发的一站式解决方案。此项目包含开发分布式应用微服务的必需组件，方便开发者通过 Spring Cloud 编程模型轻松使用这些组件来开发分布式应用服务。</p>
<p>依托 Spring Cloud Alibaba，您只需要添加一些注解和少量配置，就可以将 Spring Cloud 应用接入阿里微服务解决方案，通过阿里中间件来迅速搭建分布式应用系统。</p>
<h3 id="1-3-1-主要功能"><a href="#1-3-1-主要功能" class="headerlink" title="1.3.1  主要功能"></a>1.3.1  主要功能</h3><ul>
<li><strong>服务限流降级</strong>：默认支持 WebServlet、WebFlux， OpenFeign、RestTemplate、Spring Cloud Gateway， Zuul， Dubbo 和 RocketMQ 限流降级功能的接入，可以在运行时通过控制台实时修改限流降级规则，还支持查看限流降级 Metrics 监控。</li>
<li><strong>服务注册与发现</strong>：适配 Spring Cloud 服务注册与发现标准，默认集成了 Ribbon 的支持。</li>
<li><strong>分布式配置管理</strong>：支持分布式系统中的外部化配置，配置更改时自动刷新。</li>
<li><strong>消息驱动能力</strong>：基于 Spring Cloud Stream 为微服务应用构建消息驱动能力。</li>
<li><strong>分布式事务</strong>：使用 @GlobalTransactional 注解， 高效并且对业务零侵入地解决分布式事务问题。</li>
<li><strong>阿里云对象存储</strong>：阿里云提供的海量、安全、低成本、高可靠的云存储服务。支持在任何应用、任 何时间、任何地点存储和访问任意类型的数据。</li>
<li><strong>分布式任务调度</strong>：提供秒级、精准、高可靠、高可用的定时（基于 Cron 表达式）任务调度服务。同时提供分布式的任务执行模型，如网格任务。网格任务支持海量子任务均匀分配到所有Worker（schedulerx-client）上执行。</li>
<li><strong>阿里云短信服务</strong>：覆盖全球的短信服务，友好、高效、智能的互联化通讯能力，帮助企业迅速搭建 客户触达通道。</li>
</ul>
<h3 id="1-3-2-组件"><a href="#1-3-2-组件" class="headerlink" title="1.3.2  组件"></a>1.3.2  组件</h3><ul>
<li><strong>Sentinel</strong>：把流量作为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。</li>
<li><strong>Nacos</strong>：一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。</li>
<li><strong>RocketMQ</strong>：一款开源的分布式消息系统，基于高可用分布式集群技术，提供低延时的、高可靠 的消息发布与订阅服务。</li>
<li><strong>Dubbo</strong>：Apache Dubbo™ 是一款高性能 Java RPC 框架。</li>
<li><strong>Seata</strong>：阿里巴巴开源产品，一个易于使用的高性能微服务分布式事务解决方案。</li>
<li><strong>Alibaba Cloud ACM</strong>：一款在分布式架构环境中对应用配置进行集中管理和推送的应用配置中心产品。</li>
<li><strong>Alibaba Cloud OSS</strong>: 阿里云对象存储服务（Object Storage Service，简称 OSS），是阿里云提 供的海量、安全、低成本、高可靠的云存储服务。您可以在任何应用、任何时间、任何地点存储和 访问任意类型的数据。</li>
<li><strong>Alibaba Cloud SchedulerX</strong>: 阿里中间件团队开发的一款分布式任务调度产品，提供秒级、精准、高可靠、高可用的定时（基于 Cron 表达式）任务调度服务。</li>
<li><strong>Alibaba Cloud SMS</strong>: 覆盖全球的短信服务，友好、高效、智能的互联化通讯能力，帮助企业迅速搭建客户触达通道。</li>
</ul>
<h1 id="第二章-微服务环境搭建"><a href="#第二章-微服务环境搭建" class="headerlink" title="第二章 微服务环境搭建"></a>第二章 微服务环境搭建</h1><p>本次是使用的电商项目中的商品、订单、用户为案例进行讲解。</p>
<h2 id="2-1-案例准备"><a href="#2-1-案例准备" class="headerlink" title="2.1  案例准备"></a>2.1  案例准备</h2><h3 id="2-1-1-技术选型"><a href="#2-1-1-技术选型" class="headerlink" title="2.1.1  技术选型"></a>2.1.1  技术选型</h3><p>maven：3.3.9</p>
<p>数据库：MySQL 5.7</p>
<p>持久层: SpingData Jpa</p>
<p>其他: SpringCloud Alibaba 技术栈</p>
<h3 id="2-1-2-模块设计"><a href="#2-1-2-模块设计" class="headerlink" title="2.1.2  模块设计"></a>2.1.2  模块设计</h3><ul>
<li>springcloud-alibaba 父工程</li>
<li>shop-common 公共模块【实体类】</li>
<li>shop-user 用户微服务 【端口: 807x】</li>
<li>shop-product 商品微服务 【端口: 808x】</li>
<li>shop-order 订单微服务 【端口: 809x】</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314170040.png" alt="image-20210314170040663"></p>
<h3 id="2-1-3-微服务调用"><a href="#2-1-3-微服务调用" class="headerlink" title="2.1.3  微服务调用"></a>2.1.3  微服务调用</h3><p>在微服务架构中，最常见的场景就是微服务之间的相互调用。我们以电商系统中常见的<strong>用户下单</strong>为 例来演示微服务的调用：客户向订单微服务发起一个下单的请求，在进行保存订单之前需要调用商品微 服务查询商品的信息。</p>
<p>我们一般把服务的主动调用方称为<strong>服务消费者</strong>，把服务的被调用方称为<strong>服务提供者</strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314170114.png" alt="image-20210314170114588"></p>
<p>在这种场景下，订单微服务就是一个服务消费者， 商品微服务就是一个服务提供者。</p>
<h2 id="2-2-创建父工程"><a href="#2-2-创建父工程" class="headerlink" title="2.2  创建父工程"></a>2.2  创建父工程</h2><p>创建一个maven工程，然后在pom.xml文件中添加下面内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.wb&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;springCloudAlibaba&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;packaging&gt;pom&lt;&#x2F;packaging&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;modules&gt;</span><br><span class="line">        &lt;module&gt;shop-common&lt;&#x2F;module&gt;</span><br><span class="line">        &lt;module&gt;shop-user&lt;&#x2F;module&gt;</span><br><span class="line">        &lt;module&gt;shop-product&lt;&#x2F;module&gt;</span><br><span class="line">        &lt;module&gt;shop-order&lt;&#x2F;module&gt;</span><br><span class="line">    &lt;&#x2F;modules&gt;</span><br><span class="line"></span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.1.3.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;&#x2F;java.version&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;&#x2F;project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;project.reporting.outputEncoding&gt;UTF- 8&lt;&#x2F;project.reporting.outputEncoding&gt;</span><br><span class="line">        &lt;spring-cloud.version&gt;Greenwich.RELEASE&lt;&#x2F;spring-cloud.version&gt;</span><br><span class="line">        &lt;spring-cloud-alibaba.version&gt;2.1.0.RELEASE&lt;&#x2F;spring-cloud-alibaba.version&gt;</span><br><span class="line">    &lt;&#x2F;properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencyManagement&gt;</span><br><span class="line">        &lt;dependencies&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-cloud-dependencies&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;type&gt;pom&lt;&#x2F;type&gt;</span><br><span class="line">                &lt;scope&gt;import&lt;&#x2F;scope&gt;</span><br><span class="line">            &lt;&#x2F;dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;com.alibaba.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-cloud-alibaba-dependencies&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;spring-cloud-alibaba.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;type&gt;pom&lt;&#x2F;type&gt;</span><br><span class="line">                &lt;scope&gt;import&lt;&#x2F;scope&gt;</span><br><span class="line">            &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;&#x2F;dependencies&gt;</span><br><span class="line">    &lt;&#x2F;dependencyManagement&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>
<p>版本对应：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314213835.png" alt="image-20210314213835253"></p>
<h2 id="2-3-创建基础模块"><a href="#2-3-创建基础模块" class="headerlink" title="2.3  创建基础模块"></a>2.3  创建基础模块</h2><p>1    创建shop-common 模块，在pom.xml中添加依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;springCloudAlibaba&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;com.wb&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;shop-common&lt;&#x2F;artifactId&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.2.56&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;5.1.6&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>
<p>2 创建实体类</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.wb.domain;</span><br><span class="line"></span><br><span class="line">import lombok.Data;</span><br><span class="line"></span><br><span class="line">import javax.persistence.Entity;</span><br><span class="line">import javax.persistence.GeneratedValue;</span><br><span class="line">import javax.persistence.GenerationType;</span><br><span class="line">import javax.persistence.Id;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;14&#x2F;</span><br><span class="line"> * @Description:用户</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Entity(name &#x3D; &quot;shop_user&quot;) &#x2F;&#x2F;实体类跟数据表对应</span><br><span class="line">@Data</span><br><span class="line">public class User &#123;</span><br><span class="line"></span><br><span class="line">    @Id</span><br><span class="line">    @GeneratedValue(strategy &#x3D; GenerationType.IDENTITY)     &#x2F;&#x2F;数据库自增长</span><br><span class="line">    private Integer uid;&#x2F;&#x2F;主键</span><br><span class="line">    private String username;&#x2F;&#x2F;用户名</span><br><span class="line">    private String password;&#x2F;&#x2F;密码</span><br><span class="line">    private String telephone;&#x2F;&#x2F;手机号</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.wb.domain;</span><br><span class="line"></span><br><span class="line">import lombok.Data;</span><br><span class="line"></span><br><span class="line">import javax.persistence.Entity;</span><br><span class="line">import javax.persistence.GeneratedValue;</span><br><span class="line">import javax.persistence.GenerationType;</span><br><span class="line">import javax.persistence.Id;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;14&#x2F;</span><br><span class="line"> * @Description:商品</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Entity(name &#x3D; &quot;shop_product&quot;)</span><br><span class="line">@Data</span><br><span class="line">public class Product &#123;</span><br><span class="line"></span><br><span class="line">    @Id</span><br><span class="line">    @GeneratedValue(strategy &#x3D; GenerationType.IDENTITY)</span><br><span class="line">    private Integer pid;&#x2F;&#x2F;主键</span><br><span class="line"></span><br><span class="line">    private String pname;&#x2F;&#x2F;商品名称</span><br><span class="line"></span><br><span class="line">    private Double pprice;&#x2F;&#x2F;商品价格</span><br><span class="line"></span><br><span class="line">    private Integer stock;&#x2F;&#x2F;库存</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.wb.domain;</span><br><span class="line"></span><br><span class="line">import lombok.Data;</span><br><span class="line"></span><br><span class="line">import javax.persistence.Entity;</span><br><span class="line">import javax.persistence.GeneratedValue;</span><br><span class="line">import javax.persistence.GenerationType;</span><br><span class="line">import javax.persistence.Id;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;14&#x2F;</span><br><span class="line"> * @Description:订单</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Entity(name &#x3D; &quot;shop_order&quot;)</span><br><span class="line">@Data</span><br><span class="line">public class Order &#123;</span><br><span class="line"></span><br><span class="line">    @Id</span><br><span class="line">    @GeneratedValue(strategy &#x3D; GenerationType.IDENTITY)</span><br><span class="line">    private Long oid;&#x2F;&#x2F;订单id</span><br><span class="line"></span><br><span class="line">    private Integer uid;&#x2F;&#x2F; 用户</span><br><span class="line"></span><br><span class="line">    private String username;&#x2F;&#x2F;用户名</span><br><span class="line"></span><br><span class="line">    private Integer pid;&#x2F;&#x2F;商品id</span><br><span class="line"></span><br><span class="line">    private String pname;&#x2F;&#x2F;商品名称</span><br><span class="line"></span><br><span class="line">    private Double pprice;&#x2F;&#x2F;商品单价</span><br><span class="line"></span><br><span class="line">    private Integer number;&#x2F;&#x2F;购买数量</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="2-4-创建用户微服务"><a href="#2-4-创建用户微服务" class="headerlink" title="2.4  创建用户微服务"></a>2.4  创建用户微服务</h2><p>步骤:</p>
<ul>
<li>1 创建模块 导入依赖</li>
<li>2 创建SpringBoot主类</li>
<li>3 加入配置文件</li>
<li>4 创建必要的接口和实现类(controller service dao)</li>
</ul>
<p>1 创建pom.xml</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;springCloudAlibaba&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;com.wb&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;shop-user&lt;&#x2F;artifactId&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.wb&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;shop-common&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>
<p>2 编写主类</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.wb;</span><br><span class="line"></span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;14&#x2F;</span><br><span class="line"> * @Description:User服务</span><br><span class="line"> *&#x2F;</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class UserApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(UserApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>3 创建配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8071</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: service-user</span><br><span class="line">  datasource:</span><br><span class="line">    driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">    url: jdbc:mysql:&#x2F;&#x2F;&#x2F;shop?serverTimezone&#x3D;UTC&amp;useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf-8&amp;useSSL&#x3D;true</span><br><span class="line">    username: root</span><br><span class="line">    password: root</span><br><span class="line">  jpa:</span><br><span class="line">    properties:</span><br><span class="line">      hibernate:</span><br><span class="line">        hbm2ddl:</span><br><span class="line">          auto: update</span><br><span class="line">        dialect: org.hibernate.dialect.MySQL5InnoDBDialect</span><br></pre></td></tr></table></figure>
<h2 id="2-5-创建商品微服务"><a href="#2-5-创建商品微服务" class="headerlink" title="2.5  创建商品微服务"></a>2.5  创建商品微服务</h2><p>1    创建一个名为shop_product 的模块，并添加springboot依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;springCloudAlibaba&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;com.wb&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;shop-product&lt;&#x2F;artifactId&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.wb&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;shop-common&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>
<p>2 创建工程的主类</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.wb;</span><br><span class="line"></span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;14&#x2F;</span><br><span class="line"> * @Description:product服务</span><br><span class="line"> *&#x2F;</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class ProductApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(ProductApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>3 创建配置文件application.yml</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8081</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: service-product</span><br><span class="line">  datasource:</span><br><span class="line">    driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">    url: jdbc:mysql:&#x2F;&#x2F;&#x2F;shop?serverTimezone&#x3D;UTC&amp;useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf-8&amp;useSSL&#x3D;true</span><br><span class="line">    username: root</span><br><span class="line">    password: root</span><br><span class="line">  jpa:</span><br><span class="line">    properties:</span><br><span class="line">      hibernate:</span><br><span class="line">        hbm2ddl:</span><br><span class="line">          auto: update</span><br><span class="line">        dialect: org.hibernate.dialect.MySQL5InnoDBDialect</span><br></pre></td></tr></table></figure>
<p>4 创建ProductDao接口</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.wb.product.dao;</span><br><span class="line"></span><br><span class="line">import com.wb.domain.Product;</span><br><span class="line">import org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;14&#x2F;</span><br><span class="line"> * @Description:</span><br><span class="line"> *&#x2F;</span><br><span class="line">public interface ProductDao extends JpaRepository&lt;Product,Integer&gt; &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>5 创建ProductService接口和实现类</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.wb.product.service;</span><br><span class="line"></span><br><span class="line">import com.wb.domain.Product;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;14&#x2F;</span><br><span class="line"> * @Description:</span><br><span class="line"> *&#x2F;</span><br><span class="line">public interface ProductService &#123;</span><br><span class="line"></span><br><span class="line">    Product findByPid(Integer pid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.wb.product.service.impl;</span><br><span class="line"></span><br><span class="line">import com.wb.domain.Product;</span><br><span class="line">import com.wb.product.dao.ProductDao;</span><br><span class="line">import com.wb.product.service.ProductService;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;14&#x2F;</span><br><span class="line"> * @Description:</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Service</span><br><span class="line">public class ProductServiceImpl implements ProductService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private ProductDao productDao;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Product findByPid(Integer pid) &#123;</span><br><span class="line">        return productDao.findById(pid).get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>6 创建Controller</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.wb.product.controller;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.wb.domain.Product;</span><br><span class="line">import com.wb.product.service.ProductService;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;14&#x2F;</span><br><span class="line"> * @Description:</span><br><span class="line"> *&#x2F;</span><br><span class="line">@RestController</span><br><span class="line">@Slf4j</span><br><span class="line">public class ProductController &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private ProductService productService;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;&#x2F;product&#x2F;&#123;pid&#125;&quot;)</span><br><span class="line">    public Product findProductById(@PathVariable(&quot;pid&quot;) Integer pid) &#123;</span><br><span class="line">        log.info(&quot;查询的商品id为&#123;&#125;&quot;+pid);</span><br><span class="line">        Product product &#x3D; productService.findByPid(pid);</span><br><span class="line">        log.info(&quot;查询到的商品信息为：&#123;&#125;&quot;+ JSON.toJSONString(product));</span><br><span class="line">        return product;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>7 启动工程，等到数据库表创建完毕之后，加入测试数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO shop_product VALUE(NULL,&#39;小米&#39;,&#39;1000&#39;,&#39;5000&#39;);</span><br><span class="line">INSERT INTO shop_product VALUE(NULL,&#39;华为&#39;,&#39;2000&#39;,&#39;5000&#39;); </span><br><span class="line">INSERT INTO shop_product VALUE(NULL,&#39;苹果&#39;,&#39;3000&#39;,&#39;5000&#39;); </span><br><span class="line">INSERT INTO shop_product VALUE(NULL,&#39;OPPO&#39;,&#39;4000&#39;,&#39;5000&#39;);</span><br></pre></td></tr></table></figure>
<p>8 通过浏览器访问服务</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314214747.png" alt="image-20210314214747585"></p>
<h2 id="2-6-创建订单微服务"><a href="#2-6-创建订单微服务" class="headerlink" title="2.6  创建订单微服务"></a>2.6  创建订单微服务</h2><p>步骤如上：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;springCloudAlibaba&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;com.wb&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;shop-order&lt;&#x2F;artifactId&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.wb&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;shop-common&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8091</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: service-order</span><br><span class="line">  datasource:</span><br><span class="line">    driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">    url: jdbc:mysql:&#x2F;&#x2F;&#x2F;shop?serverTimezone&#x3D;UTC&amp;useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf-8&amp;useSSL&#x3D;true</span><br><span class="line">    username: root</span><br><span class="line">    password: root</span><br><span class="line">  jpa:</span><br><span class="line">    properties:</span><br><span class="line">      hibernate:</span><br><span class="line">        hbm2ddl:</span><br><span class="line">          auto: update</span><br><span class="line">        dialect: org.hibernate.dialect.MySQL5InnoDBDialect</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.wb;</span><br><span class="line"></span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;14&#x2F;</span><br><span class="line"> * @Description:</span><br><span class="line"> *&#x2F;</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class OrderApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(OrderApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public RestTemplate restTemplate()&#123;</span><br><span class="line">        return new RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.wb.order.dao;</span><br><span class="line"></span><br><span class="line">import com.wb.domain.Order;</span><br><span class="line">import org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;14&#x2F;</span><br><span class="line"> * @Description:</span><br><span class="line"> *&#x2F;</span><br><span class="line">public interface OrderDao extends JpaRepository&lt;Order,Integer&gt; &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.wb.order.controller;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.wb.domain.Order;</span><br><span class="line">import com.wb.domain.Product;</span><br><span class="line">import com.wb.order.service.OrderService;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line">import org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;14&#x2F;</span><br><span class="line"> * @Description:</span><br><span class="line"> *&#x2F;</span><br><span class="line">@RestController</span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderController &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RestTemplate restTemplate;</span><br><span class="line">    @Autowired</span><br><span class="line">    private OrderService orderService;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;&#x2F;order&#x2F;prod&#x2F;&#123;pid&#125;&quot;)</span><br><span class="line">    public Order saveOrder(@PathVariable(&quot;pid&quot;)Integer pid)&#123;</span><br><span class="line">        log.info(&quot;接收到&#123;&#125;号商品下单请求，调用商品微服务查询信息&quot;,pid);</span><br><span class="line">        Product product &#x3D;</span><br><span class="line">                restTemplate.getForObject(&quot;http:&#x2F;&#x2F;localhost:8081&#x2F;product&#x2F;&quot;+pid,Product.class);</span><br><span class="line">        log.info(&quot;查询到的商品为：&#123;&#125;&quot;+ JSON.toJSONString(product));</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;创建订单</span><br><span class="line">        Order order &#x3D; new Order();</span><br><span class="line">        order.setUid(1);</span><br><span class="line">        order.setUsername(&quot;蜡笔小新&quot;);</span><br><span class="line"></span><br><span class="line">        order.setPid(product.getPid());</span><br><span class="line">        order.setPname(product.getPname());</span><br><span class="line">        order.setPprice(product.getPprice());</span><br><span class="line"></span><br><span class="line">        order.setNumber(10);</span><br><span class="line"></span><br><span class="line">        orderService.createOrder(order);</span><br><span class="line"></span><br><span class="line">        log.info(&quot;创建订单成功，订单为：&#123;&#125;&quot;+ JSON.toJSONString(order));</span><br><span class="line"></span><br><span class="line">        return order;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.wb.order.service;</span><br><span class="line"></span><br><span class="line">import com.wb.domain.Order;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;14&#x2F;</span><br><span class="line"> * @Description:</span><br><span class="line"> *&#x2F;</span><br><span class="line">public interface OrderService &#123;</span><br><span class="line">    void createOrder(Order order);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.wb.order.service.impl;</span><br><span class="line"></span><br><span class="line">import com.wb.domain.Order;</span><br><span class="line">import com.wb.order.dao.OrderDao;</span><br><span class="line">import com.wb.order.service.OrderService;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;14&#x2F;</span><br><span class="line"> * @Description:</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Service</span><br><span class="line">public class OrderServiceImpl implements OrderService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private OrderDao orderDao;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void createOrder(Order order) &#123;</span><br><span class="line">        orderDao.save(order);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>启动工程,通过浏览器访问服务进行测试：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314215040.png" alt="image-20210314215040604"></p>
<h1 id="第三章-Nacos-Discovery–服务治理"><a href="#第三章-Nacos-Discovery–服务治理" class="headerlink" title="第三章 Nacos Discovery–服务治理"></a>第三章 Nacos Discovery–服务治理</h1><h2 id="3-1-服务治理介绍"><a href="#3-1-服务治理介绍" class="headerlink" title="3.1  服务治理介绍"></a>3.1  服务治理介绍</h2><h5 id="先来思考一个问题"><a href="#先来思考一个问题" class="headerlink" title="先来思考一个问题"></a>先来思考一个问题</h5><p>通过上一章的操作，我们已经可以实现微服务之间的调用。但是我们把服务提供者的网络地址</p>
<p>（ip，端口）等硬编码到了代码中，这种做法存在许多问题：</p>
<ul>
<li>一旦服务提供者地址变化，就需要手工修改代码</li>
<li>一旦是多个服务提供者，无法实现负载均衡功能</li>
<li>一旦服务变得越来越多，人工维护调用关系困难</li>
</ul>
<p>那么应该怎么解决呢， 这时候就需要通过注册中心动态的实现<strong>服务治理</strong>。</p>
<h5 id="什么是服务治理"><a href="#什么是服务治理" class="headerlink" title="什么是服务治理"></a>什么是服务治理</h5><p>服务治理是微服务架构中最核心最基本的模块。用于实现各个微服务的<strong>自动化注册与发现</strong>。</p>
<ul>
<li><strong>服务注册：</strong>在服务治理框架中，都会构建一个注册中心，每个服务单元向注册中心登记自己提供服 务的详细信息。并在注册中心形成一张服务的清单，服务注册中心需要以心跳的方式去监测清单中 的服务是否可用，如果不可用，需要在服务清单中剔除不可用的服务。</li>
<li><strong>服务发现：</strong>服务调用方向服务注册中心咨询服务，并获取所有服务的实例清单，实现对具体服务实例的访问。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314215317.png" alt="image-20210314215317252"></p>
<p>通过上面的调用图会发现，除了微服务，还有一个组件是<strong>服务注册中心</strong>，它是微服务架构非常重要 的一个组件，在微服务架构里主要起到了协调者的一个作用。注册中心一般包含如下几个功能：</p>
<ol>
<li>服务发现：<ul>
<li>服务注册：保存服务提供者和服务调用者的信息</li>
<li>服务订阅：服务调用者订阅服务提供者的信息，注册中心向订阅者推送提供者的信息</li>
</ul>
</li>
<li>服务配置：<ul>
<li>配置订阅：服务提供者和服务调用者订阅微服务相关的配置</li>
<li>配置下发：主动将配置推送给服务提供者和服务调用者</li>
</ul>
</li>
<li>服务健康检测：<ul>
<li>检测服务提供者的健康情况，如果发现异常，执行服务剔除</li>
</ul>
</li>
</ol>
<h5 id="常见的注册中心"><a href="#常见的注册中心" class="headerlink" title="常见的注册中心"></a>常见的注册中心</h5><ul>
<li><p><strong>Zookeeper</strong></p>
<p>zookeeper是一个分布式服务框架，是Apache Hadoop 的一个子项目，它主要是用来解决分布式应用中经常遇到的一些数据管理问题，如：统一命名服务、状态同步服务、集群管理、分布式应用 配置项的管理等。</p>
</li>
<li><p>Eureka</p>
<p>Eureka是Springcloud  Netﬂix中的重要组件，主要作用就是做服务注册和发现。但是现在已经闭源</p>
</li>
<li><p>Consul</p>
<p>Consul是基于GO语言开发的开源工具，主要面向分布式，服务化的系统提供服务注册、服务发现 和配置管理的功能。Consul的功能都很实用，其中包括：服务注册/发现、健康检查、Key/Value  存储、多数据中心和分布式一致性保证等特性。Consul本身只是一个二进制的可执行文件，所以  安装和部署都非常简单，只需要从官网下载后，在执行对应的启动脚本即可。</p>
</li>
<li><p>Nacos</p>
<p>Nacos是一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。它是 Spring Cloud Alibaba 组件之一，负责服务注册发现和服务配置，可以这样认为nacos=eureka+conﬁg。</p>
</li>
</ul>
<h2 id="3-2-nacos简介"><a href="#3-2-nacos简介" class="headerlink" title="3.2  nacos简介"></a>3.2  nacos简介</h2><p>Nacos 致力于帮助您发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理。</p>
<p>从上面的介绍就可以看出，<strong>nacos的作用就是一个注册中心</strong>，用来管理注册上来的各个微服务。</p>
<h2 id="3-3-nacos实战入门"><a href="#3-3-nacos实战入门" class="headerlink" title="3.3  nacos实战入门"></a>3.3  nacos实战入门</h2><p>接下来，我们就在现有的环境中加入nacos，并将我们的两个微服务注册上去。</p>
<h3 id="3-3-1-搭建nacos环境"><a href="#3-3-1-搭建nacos环境" class="headerlink" title="3.3.1  搭建nacos环境"></a>3.3.1  搭建nacos环境</h3><p>第1步: 安装nacos-win环境</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">下载地址: https:&#x2F;&#x2F;github.com&#x2F;alibaba&#x2F;nacos&#x2F;releases</span><br><span class="line">下载zip格式的安装包，然后进行解压缩操作</span><br></pre></td></tr></table></figure>
<p>第2步: 启动nacos</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#切换目录</span><br><span class="line">cd nacos&#x2F;bin #命令启动</span><br><span class="line">startup.cmd -m standalone</span><br></pre></td></tr></table></figure>
<p>第3步: 访问nacos</p>
<p>打开浏览器输入<a target="_blank" rel="noopener" href="http://localhost:8848/nacos%EF%BC%8C%E5%8D%B3%E5%8F%AF%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1%EF%BC%8C">http://localhost:8848/nacos，即可访问服务，</a> 默认密码是nacos/nacos</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210314220153.png" alt="image-20210314220153642"></p>
<h3 id="3-3-2-将商品微服务注册到nacos"><a href="#3-3-2-将商品微服务注册到nacos" class="headerlink" title="3.3.2  将商品微服务注册到nacos"></a>3.3.2  将商品微服务注册到nacos</h3><p>接下来开始修改shop-product 模块的代码， 将其注册到nacos服务上</p>
<p>1 在pom.xml中添加nacos的依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--nacos--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-alibaba-nacos-discovery&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p>2 在主类上添加**@EnableDiscoveryClient**注解</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">public class ProductApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(ProductApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3 在application.yml中添加nacos服务的地址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cloud:</span><br><span class="line">  nacos:</span><br><span class="line">    discovery:</span><br><span class="line">      server-addr: localhost:8848</span><br></pre></td></tr></table></figure>
<p>4 启动服务， 观察nacos的控制面板中是否有注册上来的商品微服务、</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210315231521.png" alt="image-20210315231514626"></p>
<h3 id="3-3-3-将订单微服务注册到nacos"><a href="#3-3-3-将订单微服务注册到nacos" class="headerlink" title="3.3.3  将订单微服务注册到nacos"></a>3.3.3  将订单微服务注册到nacos</h3><p>接下来开始修改shop_order 模块的代码， 将其注册到nacos服务上</p>
<p>1 在pom.xml中添加nacos的依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--nacos--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-alibaba-nacos-discovery&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p>2 在主类上添加**@EnableDiscoveryClient**注解</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">public class OrderApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(OrderApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3 在application.yml中添加nacos服务的地址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cloud:</span><br><span class="line">  nacos:</span><br><span class="line">    discovery:</span><br><span class="line">      server-addr: localhost:8848</span><br></pre></td></tr></table></figure>
<p>4  修改OrderController， 实现微服务调用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">     log.info(&quot;接收到&#123;&#125;号商品下单请求，调用商品微服务查询信息&quot;,pid);</span><br><span class="line">List&lt;ServiceInstance&gt; serviceInstances &#x3D; discoveryClient.getInstances(&quot;service-product&quot;);</span><br><span class="line">ServiceInstance instance &#x3D; serviceInstances.get(0);</span><br><span class="line">Product product &#x3D;              restTemplate.getForObject(&quot;http:&#x2F;&#x2F;&quot;+instance.getHost()+&quot;:&quot;+instance.getPort()+&quot;&#x2F;product&#x2F;&quot;+pid,Product.class);</span><br><span class="line">        log.info(&quot;查询到的商品为：&#123;&#125;&quot;+ JSON.toJSONString(product));</span><br><span class="line">        &#x2F;&#x2F;创建订单</span><br><span class="line">        Order order &#x3D; new Order();</span><br><span class="line">        order.setUid(1);</span><br><span class="line">        order.setUsername(&quot;蜡笔小新&quot;);</span><br><span class="line">        order.setPid(product.getPid());</span><br><span class="line">        order.setPname(product.getPname());</span><br><span class="line">        order.setPprice(product.getPprice());</span><br><span class="line">        order.setNumber(10);</span><br><span class="line"></span><br><span class="line">        orderService.createOrder(order);</span><br><span class="line">        log.info(&quot;创建订单成功，订单为：&#123;&#125;&quot;+ JSON.toJSONString(order));</span><br><span class="line">        return order;</span><br></pre></td></tr></table></figure>
<p>DiscoveryClient是专门负责服务注册和发现的，我们可以通过它获取到注册到注册中心的所有服务</p>
<p>5 启动服务， 观察nacos的控制面板中是否有注册上来的订单微服务，然后通过访问消费者服务验证调用是否成功</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210315231953.png" alt="image-20210315231952962"></p>
<h2 id="3-4-实现服务调用的负载均衡"><a href="#3-4-实现服务调用的负载均衡" class="headerlink" title="3.4  实现服务调用的负载均衡"></a>3.4  实现服务调用的负载均衡</h2><h3 id="3-4-1-什么是负载均衡"><a href="#3-4-1-什么是负载均衡" class="headerlink" title="3.4.1  什么是负载均衡"></a>3.4.1  什么是负载均衡</h3><p>通俗的讲， 负载均衡就是将负载（工作任务，访问请求）进行分摊到多个操作单元（服务器,组件）上进行执行。</p>
<p>根据负载均衡发生位置的不同,一般分为<strong>服务端负载均衡</strong>和<strong>客户端负载均衡</strong>。服务端负载均衡指的是发生在服务提供者一方,比如常见的nginx负载均衡</p>
<p>而客户端负载均衡指的是发生在服务请求的一方，也就是在发送请求之前已经选好了由哪个实例处理请求。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210315232046.png" alt="image-20210315232046015"></p>
<p>我们在微服务调用关系中一般会选择客户端负载均衡，也就是在服务调用的一方来决定服务由哪个提供 者执行。</p>
<h3 id="3-4-2-自定义实现负载均衡"><a href="#3-4-2-自定义实现负载均衡" class="headerlink" title="3.4.2  自定义实现负载均衡"></a>3.4.2  自定义实现负载均衡</h3><ol>
<li>通过idea再启动一个shop-product 微服务，设置其端口为8082</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210315232148.png" alt="image-20210315232148556"></p>
<ol start="2">
<li>通过nacos查看微服务的启动情况</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210315232246.png" alt="image-20210315232246264"></p>
<ol start="3">
<li>修改shop-order 的代码，实现负载均衡</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;自定义负载均衡</span><br><span class="line">      log.info(&quot;接收到&#123;&#125;号商品下单请求，调用商品微服务查询信息&quot;,pid);</span><br><span class="line"></span><br><span class="line">      List&lt;ServiceInstance&gt; serviceInstances &#x3D; discoveryClient.getInstances(&quot;service-product&quot;);</span><br><span class="line">      &#x2F;&#x2F;随机选择</span><br><span class="line">      int nextInt &#x3D; new Random().nextInt(serviceInstances.size());</span><br><span class="line">      ServiceInstance instance &#x3D; serviceInstances.get(nextInt);</span><br><span class="line"></span><br><span class="line">      Product product &#x3D;</span><br><span class="line">              restTemplate.getForObject(&quot;http:&#x2F;&#x2F;&quot;+instance.getHost()+&quot;:&quot;+instance.getPort()+&quot;&#x2F;product&#x2F;&quot;+pid,Product.class);</span><br><span class="line">      log.info(&quot;查询到的商品为：&#123;&#125;&quot;+ JSON.toJSONString(product));</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F;创建订单</span><br><span class="line">      Order order &#x3D; new Order();</span><br><span class="line">      order.setUid(1);</span><br><span class="line">      order.setUsername(&quot;蜡笔小新&quot;);</span><br><span class="line"></span><br><span class="line">      order.setPid(product.getPid());</span><br><span class="line">      order.setPname(product.getPname());</span><br><span class="line">      order.setPprice(product.getPprice());</span><br><span class="line"></span><br><span class="line">      order.setNumber(10);</span><br><span class="line"></span><br><span class="line">      orderService.createOrder(order);</span><br><span class="line"></span><br><span class="line">      log.info(&quot;创建订单成功，订单为：&#123;&#125;&quot;+ JSON.toJSONString(order));</span><br><span class="line"></span><br><span class="line">      return order;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="3-4-3-基于Ribbon实现负载均衡"><a href="#3-4-3-基于Ribbon实现负载均衡" class="headerlink" title="3.4.3  基于Ribbon实现负载均衡"></a>3.4.3  基于Ribbon实现负载均衡</h3><p>Ribbon是Spring Cloud的一个组件， 它可以让我们使用一个注解就能轻松的搞定负载均衡</p>
<p>第1步：在RestTemplate 的生成方法上添加@LoadBalanced注解</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Bean</span><br><span class="line">@LoadBalanced</span><br><span class="line">public RestTemplate restTemplate() &#123; return new RestTemplate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第2步：修改服务调用的方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;Ribbon负载均衡</span><br><span class="line">        log.info(&quot;接收到&#123;&#125;号商品下单请求，调用商品微服务查询信息&quot;,pid);</span><br><span class="line"></span><br><span class="line">        Product product &#x3D;</span><br><span class="line">                restTemplate.getForObject(&quot;http:&#x2F;&#x2F;service-product&#x2F;product&#x2F;&quot;+pid,Product.class);</span><br><span class="line">        log.info(&quot;查询到的商品为：&#123;&#125;&quot;+ JSON.toJSONString(product));</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;创建订单</span><br><span class="line">        Order order &#x3D; new Order();</span><br><span class="line">        order.setUid(1);</span><br><span class="line">        order.setUsername(&quot;蜡笔小新&quot;);</span><br><span class="line"></span><br><span class="line">        order.setPid(product.getPid());</span><br><span class="line">        order.setPname(product.getPname());</span><br><span class="line">        order.setPprice(product.getPprice());</span><br><span class="line"></span><br><span class="line">        order.setNumber(10);</span><br><span class="line"></span><br><span class="line">        orderService.createOrder(order);</span><br><span class="line"></span><br><span class="line">        log.info(&quot;创建订单成功，订单为：&#123;&#125;&quot;+ JSON.toJSONString(order));</span><br><span class="line"></span><br><span class="line">        return order;</span><br></pre></td></tr></table></figure>
<p>Ribbon支持的负载均衡策略</p>
<p>Ribbon内置了多种负载均衡策略,内部负载均衡的顶级接口com.netflix.loadbalancer.IRule , 具体的负载策略如下图所示:</p>
<table>
<thead>
<tr>
<th align="left"><strong>策略名</strong></th>
<th><strong>策略描述</strong></th>
<th><strong>实现说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">BestAvailableRule</td>
<td>选择一个最小的并发请求的server</td>
<td>逐个考察Server，如果Server被tripped了，则忽略，在选择其中ActiveRequestsCount最小的server</td>
</tr>
<tr>
<td align="left">AvailabilityFilteringRule</td>
<td>过滤掉那些因为一直连接失败的被标记为circuit tripped的后端server，并过滤掉那些高并发的的后端server（active connections 超过配置的阈值）</td>
<td>使用一个AvailabilityPredicate来包含过滤server的逻辑，其实就就是检查status里记录的各个server的运行状态</td>
</tr>
<tr>
<td align="left">WeightedResponseTimeRule</td>
<td>根据相应时间分配一个weight，相应时间越长，weight越小，被选中的可能性越低。</td>
<td>一个后台线程定期的从status里面读取评价响应时间，为每个server计算一个weight。Weight的计算也比较简单responsetime 减去每个server自己平均的responsetime是server的权重。当刚开始运行，没有形成statas 时，使用roubine策略选择server。</td>
</tr>
<tr>
<td align="left">RetryRule</td>
<td>对选定的负载均衡策略机上重试机制。</td>
<td>在一个配置时间段内当选择server不成功，则一直尝试使用subRule的方式选择一个可用的server</td>
</tr>
<tr>
<td align="left">RoundRobinRule</td>
<td>轮询方式轮询选择  server</td>
<td>轮询index，选择index对应位置的  server</td>
</tr>
<tr>
<td align="left">RandomRule</td>
<td>随机选择一个server</td>
<td>在index上随机，选择index对应位置的server</td>
</tr>
<tr>
<td align="left">ZoneAvoidanceRule</td>
<td>复合判断server所在区域的性能和server 的可用性选择server</td>
<td>使用ZoneAvoidancePredicate和AvailabilityPredicate来判断是否选择某个server，前一个判断判定一个zone的运行性能是否可用，剔除不可用 的 zone（ 的 所 有 server）， AvailabilityPredicate用于过滤掉连接数过多的Server。</td>
</tr>
</tbody></table>
<p>我们可以通过修改配置来调整Ribbon的负载均衡策略，具体代码如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">service-product: # 调用的提供者的名称</span><br><span class="line">  ribbon:</span><br><span class="line">    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule  #策略</span><br></pre></td></tr></table></figure>
<h2 id="3-5-基于Feign实现服务调用"><a href="#3-5-基于Feign实现服务调用" class="headerlink" title="3.5  基于Feign实现服务调用"></a>3.5  基于Feign实现服务调用</h2><h3 id="3-5-1-什么是Feign"><a href="#3-5-1-什么是Feign" class="headerlink" title="3.5.1  什么是Feign"></a>3.5.1  什么是Feign</h3><p>Feign是Spring Cloud提供的一个声明式的伪Http客户端， 它使得调用远程服务就像调用本地服务一样简单， 只需要创建一个接口并添加一个注解即可。</p>
<p>Nacos很好的兼容了Feign， Feign默认集成了 Ribbon， 所以在Nacos下使用Fegin默认就实现了负载均衡的效果。</p>
<h3 id="3-5-2-Feign的使用"><a href="#3-5-2-Feign的使用" class="headerlink" title="3.5.2  Feign的使用"></a>3.5.2  Feign的使用</h3><p>1 加入Fegin的依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--fegin--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p>2 在主类上添加Fegin的注解</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">@EnableFeignClients     &#x2F;&#x2F;开启Fegin</span><br><span class="line">public class OrderApplication &#123; --- &#125;</span><br></pre></td></tr></table></figure>
<p>3 创建一个接口， 并使用Fegin实现微服务调用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@FeignClient(value &#x3D; &quot;service-product&quot;)</span><br><span class="line">public interface ProductFeginService &#123;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;&#x2F;product&#x2F;&#123;pid&#125;&quot;)</span><br><span class="line">    Product findProductById(@PathVariable(&quot;pid&quot;) Integer pid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>4 修改controller代码，并启动验证</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> &#x2F;&#x2F;Fegin</span><br><span class="line"> log.info(&quot;接收到&#123;&#125;号商品下单请求，调用商品微服务查询信息&quot;,pid);</span><br><span class="line"></span><br><span class="line">   Product product &#x3D;productFeginService.findProductById(pid);</span><br><span class="line"></span><br><span class="line">   log.info(&quot;查询到的商品为：&#123;&#125;&quot;+ JSON.toJSONString(product));</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F;创建订单</span><br><span class="line">   Order order &#x3D; new Order();</span><br><span class="line">   order.setUid(1);</span><br><span class="line">   order.setUsername(&quot;蜡笔小新&quot;);</span><br><span class="line"></span><br><span class="line">   order.setPid(product.getPid());</span><br><span class="line">   order.setPname(product.getPname());</span><br><span class="line">   order.setPprice(product.getPprice());</span><br><span class="line"></span><br><span class="line">   order.setNumber(10);</span><br><span class="line"></span><br><span class="line">   orderService.createOrder(order);</span><br><span class="line"></span><br><span class="line">   log.info(&quot;创建订单成功，订单为：&#123;&#125;&quot;+ JSON.toJSONString(order));</span><br><span class="line"></span><br><span class="line">return order;</span><br></pre></td></tr></table></figure>
<h1 id="第四章-Sentinel–服务容错"><a href="#第四章-Sentinel–服务容错" class="headerlink" title="第四章 Sentinel–服务容错"></a>第四章 Sentinel–服务容错</h1><h2 id="4-1-高并发带来的问题"><a href="#4-1-高并发带来的问题" class="headerlink" title="4.1  高并发带来的问题"></a>4.1  高并发带来的问题</h2><p>在微服务架构中，我们将业务拆分成一个个的服务，服务与服务之间可以相互调用，但是由于网络 原因或者自身的原因，服务并不能保证服务的100%可用，如果单个服务出现问题，调用这个服务就会  出现网络延迟，此时若有大量的网络涌入，会形成任务堆积，最终导致服务瘫痪。</p>
<p><strong>接下来，我们来模拟一个高并发的场景</strong></p>
<p>1 编写java代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderController2 &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private OrderService orderService;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private ProductFeginService productFeginService;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;&#x2F;order&#x2F;prod&#x2F;&#123;pid&#125;&quot;)</span><br><span class="line">    public Order saveOrder(@PathVariable(&quot;pid&quot;)Integer pid) &#123;</span><br><span class="line">        &#x2F;&#x2F;Fegin</span><br><span class="line">        log.info(&quot;接收到&#123;&#125;号商品下单请求，调用商品微服务查询信息&quot;, pid);</span><br><span class="line"></span><br><span class="line">        Product product &#x3D; productFeginService.findProductById(pid);</span><br><span class="line"></span><br><span class="line">        log.info(&quot;查询到的商品为：&#123;&#125;&quot; + JSON.toJSONString(product));</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(2000);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;创建订单</span><br><span class="line">        Order order &#x3D; new Order();</span><br><span class="line">        order.setUid(1);</span><br><span class="line">        order.setUsername(&quot;蜡笔小新&quot;);</span><br><span class="line"></span><br><span class="line">        order.setPid(product.getPid());</span><br><span class="line">        order.setPname(product.getPname());</span><br><span class="line">        order.setPprice(product.getPprice());</span><br><span class="line"></span><br><span class="line">        order.setNumber(10);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;        orderService.createOrder(order);</span><br><span class="line"></span><br><span class="line">        log.info(&quot;创建订单成功，订单为：&#123;&#125;&quot; + JSON.toJSONString(order));</span><br><span class="line"></span><br><span class="line">        return order;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;测试高并发</span><br><span class="line">    @RequestMapping(&quot;&#x2F;order&#x2F;message&quot;)</span><br><span class="line">    public String msg()&#123;</span><br><span class="line">        return &quot;测试高并发&#x3D;&#x3D;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2 修改配置文件中tomcat的并发数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8091</span><br><span class="line">  tomcat:</span><br><span class="line">    max-threads: 10	#tomcat的最大并发值修改为10,默认是200</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><p>接下来使用压测工具,对请求进行压力测试</p>
<p>下载地址<a target="_blank" rel="noopener" href="https://jmeter.apache.org/">https://jmeter.apache.org/</a></p>
</li>
</ol>
<p>第一步：修改配置，并启动软件</p>
<p>进入bin目录,修改jmeter.properties文件中的语言支持为language=zh_CN，然后点击jmeter.bat 启动软件。</p>
<p>第二步：添加线程组</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210316000840.png" alt="image-20210316000840052"></p>
<p>第三步：配置线程并发数</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210316000858.png" alt="image-20210316000858514"></p>
<p>第四步：添加Http取样</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210316000920.png" alt="image-20210316000920784"></p>
<p>第五步：配置取样，并启动测试</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210316000938.png" alt="image-20210316000938378"></p>
<ol start="4">
<li><p>访问ｍessage方法观察效果</p>
<p>此时会发现, 由于order方法囤积了大量请求, 导致ｍessage方法的访问出现了问题，这就是<strong>服务雪崩</strong>的雏形。</p>
</li>
</ol>
<h2 id="4-2-服务雪崩效应"><a href="#4-2-服务雪崩效应" class="headerlink" title="4.2  服务雪崩效应"></a>4.2  服务雪崩效应</h2><p>在分布式系统中,由于网络原因或自身的原因,服务一般无法保证 100% 可用。如果一个服务出现了问题，调用这个服务就会出现线程阻塞的情况，此时若有大量的请求涌入，就会出现多条线程阻塞等  待，进而导致服务瘫痪。</p>
<p>由于服务与服务之间的依赖性，故障会传播，会对整个微服务系统造成灾难性的严重后果，这就是 服务故障的 <strong>“雪崩效应</strong>” 。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210316001115.png" alt="image-20210316001115596"></p>
<p>雪崩发生的原因多种多样，有不合理的容量设计，或者是高并发下某一个方法响应变慢，亦或是某 台机器的资源耗尽。我们无法完全杜绝雪崩源头的发生，只有做好足够的容错，保证在一个服务发生问 题，不会影响到其它服务的正常运行。也就是＂雪落而不雪崩＂。</p>
<h2 id="4-3-常见容错方案"><a href="#4-3-常见容错方案" class="headerlink" title="4.3  常见容错方案"></a>4.3  常见容错方案</h2><p>要防止雪崩的扩散，我们就要做好服务的容错，容错说白了就是保护自己不被猪队友拖垮的一些措 施, 下面介绍常见的服务容错思路和组件。</p>
<h5 id="常见的容错思路"><a href="#常见的容错思路" class="headerlink" title="常见的容错思路"></a>常见的容错思路</h5><p>常见的容错思路有隔离、超时、限流、熔断、降级这几种，下面分别介绍一下。</p>
<ul>
<li><p>隔离</p>
<p>它是指将系统按照一定的原则划分为若干个服务模块，各个模块之间相对独立，无强依赖。当有故 障发生时，能将问题和影响隔离在某个模块内部，而不扩散风险，不波及其它模块，不影响整体的 系统服务。常见的隔离方式有：线程池隔离和信号量隔离．</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210316001225.png" alt="image-20210316001225772"></p>
</li>
<li><p>超时</p>
</li>
</ul>
<p>在上游服务调用下游服务的时候，设置一个最大响应时间，如果超过这个时间，下游未作出反应， 就断开请求，释放掉线程。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210316001256.png" alt="image-20210316001255906"></p>
<ul>
<li>限流</li>
</ul>
<p>限流就是限制系统的输入和输出流量已达到保护系统的目的。为了保证系统的稳固运行,一旦达到 的需要限制的阈值,就需要限制流量并采取少量措施以完成限制流量的目的。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210316001320.png" alt="image-20210316001320683"></p>
<ul>
<li><strong>熔断</strong> </li>
</ul>
<p>在互联网系统中，当下游服务因访问压力过大而响应变慢或失败，上游服务为了保护系统整体的可用性，可以暂时切断对下游服务的调用。这种牺牲局部，保全整体的措施就叫做熔断。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210316001349.png" alt="image-20210316001349562"></p>
<p>服务熔断一般有三种状态：</p>
<ol>
<li>熔断关闭状态（Closed）</li>
</ol>
<p>服务没有故障时，熔断器所处的状态，对调用方的调用不做任何限制</p>
<ol start="2">
<li>熔断开启状态（Open）</li>
</ol>
<p>后续对该服务接口的调用不再经过网络，直接执行本地的fallback方法</p>
<ol start="3">
<li>半熔断状态（Half-Open）</li>
</ol>
<p>尝试恢复服务调用，允许有限的流量调用该服务，并监控调用成功率。如果成功率达到预  期，则说明服务已恢复，进入熔断关闭状态；如果成功率仍旧很低，则重新进入熔断关闭状态。</p>
<ul>
<li>降级</li>
</ul>
<p>降级其实就是为服务提供一个托底方案，一旦服务无法正常调用，就使用托底方案</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210316001616.png" alt="image-20210316001616481"></p>
<h5 id="常见的容错组件"><a href="#常见的容错组件" class="headerlink" title="常见的容错组件"></a>常见的容错组件</h5><ul>
<li><strong>Hystrix</strong></li>
</ul>
<p>Hystrix是由Netﬂix开源的一个延迟和容错库，用于隔离访问远程系统、服务或者第三方库，防止  级联失败，从而提升系统的可用性与容错性。</p>
<ul>
<li><strong>Resilience4J</strong></li>
</ul>
<p>Resilicence4J一款非常轻量、简单，并且文档非常清晰、丰富的熔断工具，这也是Hystrix官方推 荐的替代产品。不仅如此，Resilicence4j还原生支持Spring Boot 1.x/2.x，而且监控也支持和prometheus等多款主流产品进行整合</p>
<ul>
<li><strong>Sentinel</strong></li>
</ul>
<p>Sentinel  是阿里巴巴开源的一款断路器实现，本身在阿里内部已经被大规模采用，非常稳定。下面是三个组件在各方面的对比：</p>
<table>
<thead>
<tr>
<th></th>
<th align="center"><strong>Sentinel</strong></th>
<th align="center"><strong>Hystrix</strong></th>
<th align="center"><strong>resilience4j</strong></th>
</tr>
</thead>
<tbody><tr>
<td>隔离策略</td>
<td align="center">信号量隔离（并发线程数限流）</td>
<td align="center">线程池隔离/信号量隔离</td>
<td align="center">信号量隔离</td>
</tr>
<tr>
<td>熔断降级策略</td>
<td align="center">基于响应时间、异常比率、异常数</td>
<td align="center">基于异常比率</td>
<td align="center">基于异常比率、响应时间</td>
</tr>
<tr>
<td>实时统计实现</td>
<td align="center">滑动窗口（LeapArray）</td>
<td align="center">滑动窗口（基于 RxJava）</td>
<td align="center">Ring Bit Buﬀer</td>
</tr>
<tr>
<td>动态规则配置</td>
<td align="center">支持多种数据源</td>
<td align="center">支持多种数据源</td>
<td align="center">有限支持</td>
</tr>
<tr>
<td>扩展性</td>
<td align="center">多个扩展点</td>
<td align="center">插件的形式</td>
<td align="center">接口的形式</td>
</tr>
<tr>
<td>基于注解的支持</td>
<td align="center">支持</td>
<td align="center">支持</td>
<td align="center">支持</td>
</tr>
<tr>
<td>限流</td>
<td align="center">基于 QPS，支持基于调用关系的限流</td>
<td align="center">有限的支持</td>
<td align="center">Rate Limiter</td>
</tr>
<tr>
<td>流量整形</td>
<td align="center">支持预热模式、匀速器模式、预热排队模式</td>
<td align="center">不支持</td>
<td align="center">简单的 Rate Limiter  模式</td>
</tr>
<tr>
<td>系统自适应保护</td>
<td align="center">支持</td>
<td align="center">不支持</td>
<td align="center">不支持</td>
</tr>
<tr>
<td>控制台</td>
<td align="center">提供开箱即用的控制台，可配置规则、查看秒级监控、机器发现等</td>
<td align="center">简单的监控查看</td>
<td align="center">不提供控制台，可对接其它监控系统</td>
</tr>
</tbody></table>
<h2 id="4-4-Sentinel入门"><a href="#4-4-Sentinel入门" class="headerlink" title="4.4  Sentinel入门"></a>4.4  Sentinel入门</h2><h3 id="4-4-1-什么是Sentinel"><a href="#4-4-1-什么是Sentinel" class="headerlink" title="4.4.1  什么是Sentinel"></a>4.4.1  什么是Sentinel</h3><p>Sentinel (分布式系统的流量防卫兵) 是阿里开源的一套用于<strong>服务容错</strong>的综合性解决方案。它以流量为切入点, 从<strong>流量控制、熔断降级、系统负载保护</strong>等多个维度来保护服务的稳定性。</p>
<h5 id="Sentinel-具有以下特征"><a href="#Sentinel-具有以下特征" class="headerlink" title="Sentinel 具有以下特征:"></a>Sentinel 具有以下特征:</h5><ul>
<li><p><strong>丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景, 例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用 应用等。</p>
</li>
<li><p><strong>完备的实时监控</strong>：Sentinel  提供了实时的监控功能。通过控制台可以看到接入应用的单台机器秒级数据, 甚至 500 台以下规模的集群的汇总运行情况。</p>
</li>
<li><p><strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架/库的整合模块, 例如与 Spring Cloud、Dubbo、gRPC 的整合。只需要引入相应的依赖并进行简单的配置即可快速地接入Sentinel。</p>
</li>
<li><p><strong>完善的 SPI 扩展点</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</p>
</li>
</ul>
<h5 id="Sentinel-分为两个部分"><a href="#Sentinel-分为两个部分" class="headerlink" title="Sentinel 分为两个部分:"></a>Sentinel 分为两个部分:</h5><ul>
<li>核心库（Java 客户端）不依赖任何框架/库,能够运行于所有 Java 运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持。</li>
<li>控制台（Dashboard）基于 Spring Boot 开发，打包后可以直接运行，不需要额外的 Tomcat 等应用容器。</li>
</ul>
<h3 id="4-4-2-微服务集成Sentinel"><a href="#4-4-2-微服务集成Sentinel" class="headerlink" title="4.4.2  微服务集成Sentinel"></a>4.4.2  微服务集成Sentinel</h3><p>为微服务集成Sentinel非常简单, 只需要加入Sentinel的依赖即可</p>
<p>1 在pom.xml中加入下面依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!-- sentinel--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p>2 编写一个Controller测试使用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderController3 &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;测试高并发</span><br><span class="line">    @RequestMapping(&quot;&#x2F;order&#x2F;message1&quot;)</span><br><span class="line">    public String msg1()&#123;</span><br><span class="line">        return &quot;message1&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;测试高并发</span><br><span class="line">    @RequestMapping(&quot;&#x2F;order&#x2F;message2&quot;)</span><br><span class="line">    public String msg2()&#123;</span><br><span class="line">        return &quot;message2&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-4-3-安装Sentinel控制台"><a href="#4-4-3-安装Sentinel控制台" class="headerlink" title="4.4.3  安装Sentinel控制台"></a>4.4.3  安装Sentinel控制台</h3><p>Sentinel 提供一个轻量级的控制台, 它提供机器发现、单机资源实时监控以及规则管理等功能。</p>
<p>1 下载jar包,解压到文件夹</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases">https://github.com/alibaba/Sentinel/releases</a> </p>
<p>2 启动控制台</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 直接使用jar命令启动项目(控制台本身是一个SpringBoot项目)</span><br><span class="line">java -Dserver.port&#x3D;8080 -Dcsp.sentinel.dashboard.server&#x3D;localhost:8080 -Dproject.name&#x3D;sentinel-dashboard -jar sentinel-dashboard-1.7.0.jar</span><br></pre></td></tr></table></figure>
<p>3 修改shop-order ,在里面加入有关控制台的配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sentinel:</span><br><span class="line">   transport:</span><br><span class="line">     port: 9999    #跟控制台交流的端口</span><br><span class="line">     dashboard: localhost:8080   #指定控制台服务地址</span><br></pre></td></tr></table></figure>
<p>第4步: 通过浏览器访问localhost:8080 进入控制台 ( 默认用户名密码是 sentinel/sentinel )</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320140604.png" alt="image-20210320140557640"></p>
<h5 id="补充：了解控制台的使用原理"><a href="#补充：了解控制台的使用原理" class="headerlink" title="补充：了解控制台的使用原理"></a>补充：了解控制台的使用原理</h5><p>Sentinel的控制台其实就是一个SpringBoot编写的程序。我们需要将我们的微服务程序注册到控制台上,  即在微服务中指定控制台的地址, 并且还要开启一个跟控制台传递数据的端口, 控制台也可以通过此端口调用微服务中的监控程序获取微服务的各种信息。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320140709.png" alt="image-20210320140709649"></p>
<h3 id="4-4-4-实现一个接口的限流"><a href="#4-4-4-实现一个接口的限流" class="headerlink" title="4.4.4  实现一个接口的限流"></a>4.4.4  实现一个接口的限流</h3><p>1 通过控制台为message1添加一个流控规则</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320140807.png" alt="image-20210320140807576"></p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320140846.png" alt="image-20210320140845917"></p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320140900.png" alt="image-20210320140900169"></p>
<h2 id="4-5-Sentinel的概念和功能"><a href="#4-5-Sentinel的概念和功能" class="headerlink" title="4.5  Sentinel的概念和功能"></a>4.5  Sentinel的概念和功能</h2><h3 id="4-5-1-基本概念"><a href="#4-5-1-基本概念" class="headerlink" title="4.5.1  基本概念"></a>4.5.1  基本概念</h3><ul>
<li><p>资源</p>
<p>资源就是sentinel要保护的东西</p>
<p>资源是 Sentinel 的关键概念。它可以是 Java 应用程序中的任何内容，可以是一个服务，也可以是一个方法，甚至可以是一段代码。</p>
</li>
<li><p>规则</p>
<p>规则就是用来规定如何保护资源</p>
<p>作用在资源之上, 定义以什么样的方式保护资源，主要包括流量控制规则、熔断降级规则以及系统保护规则。</p>
</li>
</ul>
<h3 id="4-5-2-重要功能"><a href="#4-5-2-重要功能" class="headerlink" title="4.5.2  重要功能"></a>4.5.2  重要功能</h3><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320141107.png" alt="image-20210320141107398"></p>
<p>Sentinel的主要功能就是容错，主要体现为下面这三个：</p>
<ul>
<li><h4 id="流量控制"><a href="#流量控制" class="headerlink" title="流量控制"></a>流量控制</h4></li>
</ul>
<p>流量控制在网络传输中是一个常用的概念，它用于调整网络包的数据。任意时间到来的请求往往是 随机不可控的，而系统的处理能力是有限的。我们需要根据系统的处理能力对流量进行控制。Sentinel 作为一个调配器，可以根据需要把随机的请求调整成合适的形状。</p>
<ul>
<li><h4 id="熔断降级"><a href="#熔断降级" class="headerlink" title="熔断降级"></a>熔断降级</h4></li>
</ul>
<p>当检测到调用链路中某个资源出现不稳定的表现，例如请求响应时间长或异常比例升高的时候，则 对这个资源的调用进行限制，让请求快速失败，避免影响到其它的资源而导致级联故障。</p>
<p>Sentinel 对这个问题采取了两种手段: </p>
<ul>
<li>通过并发线程数进行限制</li>
</ul>
<p>Sentinel  通过限制资源并发线程的数量，来减少不稳定资源对其它资源的影响。当某个资源出现不稳定的情况下，例如响应时间变长，对资源的直接影响就是会造成线程数的逐步堆  积。当线程数在特定资源上堆积到一定的数量之后，对该资源的新请求就会被拒绝。堆积的 线程完成任务后才开始继续接收请求。</p>
<ul>
<li>通过响应时间对资源进行降级</li>
</ul>
<p>除了对并发线程数进行控制以外，Sentinel  还可以通过响应时间来快速降级不稳定的资源。当依赖的资源出现响应时间过长后，所有对该资源的访问都会被直接拒绝，直到过了指定的 时间窗口之后才重新恢复。</p>
<p><strong>Sentinel和Hystrix的区别</strong></p>
<p>两者的原则是一致的, 都是当一个资源出现问题时, 让其快速失败, 不要波及到其它服务但是在限制的手段上, 确采取了完全不一样的方法:</p>
<p>Hystrix 采用的是线程池隔离的方式, 优点是做到了资源之间的隔离, 缺点是增加了线程切换的成本。</p>
<p>Sentinel 采用的是通过并发线程的数量和响应时间来对资源做限制。</p>
<ul>
<li><h4 id="系统负载保护"><a href="#系统负载保护" class="headerlink" title="系统负载保护"></a>系统负载保护</h4></li>
</ul>
<p>Sentinel 同时提供系统维度的自适应保护能力。当系统负载较高的时候，如果还持续让请求进入可能会导致系统崩溃，无法响应。在集群环境下，会把本应这台机器承载的流量转发到其 它的机器上去。如果这个时候其它的机器也处在一个边缘状态的时候，Sentinel 提供了对应的保护机制，让系统的入口流量和系统的负载达到一个平衡，保证系统在能力范围之内处理最多的请求。</p>
<p><strong>我们需要做的事情，就是在Sentinel的资源上配置各种各样的规则，来实现各种容错的功能。</strong></p>
<h2 id="4-6-Sentinel规则"><a href="#4-6-Sentinel规则" class="headerlink" title="4.6  Sentinel规则"></a>4.6  Sentinel规则</h2><h3 id="4-6-1-流控规则"><a href="#4-6-1-流控规则" class="headerlink" title="4.6.1  流控规则"></a>4.6.1  流控规则</h3><p>流量控制，其原理是监控应用流量的QPS(每秒查询率) 或并发线程数等指标，当达到指定的阈值时对流量进行控制，以避免被瞬时的流量高峰冲垮，从而保障应用的高可用性。</p>
<p>第1步: 点击簇点链路，我们就可以看到访问过的接口地址，然后点击对应的流控按钮，进入流控规则配置页面。新增流控规则界面如下:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320141613.png" alt="image-20210320141613522"></p>
<p><strong>资源名</strong>：唯一名称，默认是请求路径，可自定义</p>
<p><strong>针对来源</strong>：指定对哪个微服务进行限流，默认指default，意思是不区分来源，全部限制</p>
<p><strong>阈值类型/单机阈值</strong>：</p>
<ul>
<li>QPS（每秒请求数量）: 当调用该接口的QPS达到阈值的时候，进行限流</li>
<li>线程数：当调用该接口的线程数达到阈值的时候，进行限流（服务与服务线程数为请求节点）</li>
</ul>
<p><strong>是否集群</strong>：暂不需要集群</p>
<p>接下来我们以QPS为例来研究限流规则的配置。</p>
<h4 id="4-6-1-1-简单配置"><a href="#4-6-1-1-简单配置" class="headerlink" title="4.6.1.1 简单配置"></a>4.6.1.1 简单配置</h4><p>我们先做一个简单配置，设置阈值类型为QPS，单机阈值为3。即每秒请求量大于3的时候开始限流。</p>
<p>接下来，在流控规则页面就可以看到这个配置</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320141849.png" alt="image-20210320141849195"></p>
<p>然后快速访问/order/message1 接口，观察效果。此时发现，当QPS &gt; 3的时候，服务就不能正常响应，而是返回Blocked by Sentinel (ﬂow limiting)结果。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320141907.png" alt="image-20210320141907300"></p>
<h4 id="4-6-1-2-配置流控模式"><a href="#4-6-1-2-配置流控模式" class="headerlink" title="4.6.1.2 配置流控模式"></a>4.6.1.2 配置流控模式</h4><p>点击上面设置流控规则的<strong>编辑</strong>按钮，然后在编辑页面点击<strong>高级选项</strong>，会看到有流控模式一栏。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320142022.png" alt="image-20210320142022231"></p>
<p>sentinel共有三种流控模式，分别是：</p>
<ul>
<li>直接（默认）：接口达到限流条件时，开启限流</li>
<li>关联：当关联的资源达到限流条件时，开启限流 [适合做应用让步]</li>
<li>链路：当从某个接口过来的资源达到限流条件时，开启限流</li>
</ul>
<p>下面呢分别演示三种模式：</p>
<h5 id="直接流控模式"><a href="#直接流控模式" class="headerlink" title="直接流控模式"></a>直接流控模式</h5><p>直接流控模式是最简单的模式，当指定的接口达到限流条件时开启限流。上面案例使用的就是直接流控 模式。</p>
<h5 id="关联流控模式"><a href="#关联流控模式" class="headerlink" title="关联流控模式"></a>关联流控模式</h5><p>关联流控模式指的是，当指定接口关联的接口达到限流条件时，开启对指定接口开启限流。</p>
<p>第1步：配置限流规则, 将流控模式设置为关联，关联资源设置为的 /order/message2。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320142221.png" alt="image-20210320142221070"></p>
<p>第2步：通过JMeter软件向/order/message2连续发送请求，注意QPS一定要大于3</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320142343.png" alt="image-20210320142343461"></p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320142406.png" alt="image-20210320142406866"></p>
<p>第3步：访问/order/message1,会发现已经被限流</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320142430.png" alt="image-20210320142430053"></p>
<h5 id="链路流控模式"><a href="#链路流控模式" class="headerlink" title="链路流控模式"></a>链路流控模式</h5><p>链路流控模式指的是，当从某个接口过来的资源达到限流条件时，开启限流。它的功能有点类似于针对 来源配置项，区别在于：<strong>针对来源是针对上级微服务，而链路流控是针对上级接口，也就是说它的粒度 更细。</strong></p>
<p>第1步： 编写一个service，在里面添加一个方法message</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class OrderServiceImpl3 &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;定义资源，指定资源名</span><br><span class="line">    @SentinelResource(&quot;message&quot;)</span><br><span class="line">    public String message()&#123;</span><br><span class="line">        return &quot;message&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第2步： 在Controller中声明两个方法，分别调用service中的方法m</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderController3 &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private OrderServiceImpl3 orderServiceImpl3;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;测试高并发</span><br><span class="line">    @RequestMapping(&quot;&#x2F;order&#x2F;message1&quot;)</span><br><span class="line">    public String msg1()&#123;</span><br><span class="line">        orderServiceImpl3.message();</span><br><span class="line">        return &quot;message1&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;测试高并发</span><br><span class="line">    @RequestMapping(&quot;&#x2F;order&#x2F;message2&quot;)</span><br><span class="line">    public String msg2()&#123;</span><br><span class="line">        orderServiceImpl3.message();</span><br><span class="line">        return &quot;message2&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第3步: 禁止收敛URL的入口 context</p>
<p>从1.6.3 版本开始，Sentinel Web ﬁlter默认收敛所有URL的入口context，因此链路限流不生效</p>
<p>1.7.0 版本开始（对应SCA的2.1.1.RELEASE)，官方在CommonFilter 引入了WEB_CONTEXT_UNIFY参数，用于控制是否收敛context。将其配置为false即可根据不同的URL进行链路限流</p>
<p>SCA  2.1.1.RELEASE之后的版本,可以通过配置spring.cloud.sentinel.web-context-unify=false即可关闭收敛</p>
<p>我们当前使用的版本是SpringCloud Alibaba 2.1.0.RELEASE，无法实现链路限流。</p>
<p>我们当前使用的版本是SpringCloud Alibaba 2.1.0.RELEASE，无法实现链路限流。</p>
<p><strong>(1)</strong> 暂时将SpringCloud Alibaba的版本调整为2.1.1.RELEASE</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;spring-cloud-alibaba.version&gt;2.1.1.RELEASE&lt;&#x2F;spring-cloud-alibaba.version&gt;</span><br></pre></td></tr></table></figure>
<p><strong>(2)</strong> 配置文件中关闭sentinel的CommonFilter实例化</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">	cloud:</span><br><span class="line">		sentinel:</span><br><span class="line">			filter:</span><br><span class="line">				enabled: false</span><br></pre></td></tr></table></figure>
<p><strong>(3)</strong> 添加一个配置类，自己构建CommonFilter实例</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class FilterContextConfig &#123;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public FilterRegistrationBean sentinelFilterRegistration() &#123;</span><br><span class="line">        FilterRegistrationBean registration &#x3D; new FilterRegistrationBean();</span><br><span class="line">        registration.setFilter(new CommonFilter());</span><br><span class="line">        registration.addUrlPatterns(&quot;&#x2F;*&quot;);</span><br><span class="line">        &#x2F;&#x2F; 入口资源关闭聚合</span><br><span class="line">        registration.addInitParameter(CommonFilter.WEB_CONTEXT_UNIFY, &quot;false&quot;);</span><br><span class="line">        registration.setName(&quot;sentinelFilter&quot;);</span><br><span class="line">        registration.setOrder(1);</span><br><span class="line">        return registration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第4步: 控制台配置限流规则</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320144729.png" alt="image-20210320144729507"></p>
<p>第5步: 分别通过/order/message1 和/order/message2 访问, 发现1没问题, 2的被限流了</p>
<h4 id="4-6-1-3-配置流控效果"><a href="#4-6-1-3-配置流控效果" class="headerlink" title="4.6.1.3 配置流控效果"></a>4.6.1.3 配置流控效果</h4><ul>
<li><strong>快速失败（默认）</strong>: 直接失败，抛出异常，不做任何额外的处理，是最简单的效果</li>
<li><strong>Warm Up</strong>：它从开始阈值到最大QPS阈值会有一个缓冲阶段，一开始的阈值是最大QPS阈值的1/3，然后慢慢增长，直到最大阈值，适用于将突然增大的流量转换为缓步增长的场景</li>
<li><strong>排队等待</strong>：让请求以均匀的速度通过，单机阈值为每秒通过数量，其余的排队等待； 它还会让设置一个超时时间，当请求超过超时间时间还未处理，则会被丢弃</li>
</ul>
<h3 id="4-6-2-降级规则"><a href="#4-6-2-降级规则" class="headerlink" title="4.6.2  降级规则"></a>4.6.2  降级规则</h3><p>降级规则就是设置当满足什么条件的时候，对服务进行降级。Sentinel提供了三个衡量条件：</p>
<p>平均响应时间 ：当资源的平均响应时间超过阈值（以 ms 为单位）之后，资源进入准降级状态。如果接下来 1s 内持续进入 5 个请求，它们的 RT都持续超过这个阈值，那么在接下的时间窗口（以 s 为单位）之内，就会对这个方法进行服务降级。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320150116.png" alt="image-20210320150116418"></p>
<p>注意 Sentinel 默认统计的 RT 上限是 4900 ms，超出此阈值的都会算作 4900 ms，若需要变更此上限可以通过启动配置项 -Dcsp.sentinel.statistic.max.rt=xxx 来配置。</p>
<ul>
<li>异常比例：当资源的每秒异常总数占通过量的比值超过阈值之后，资源进入降级状态，即在接下的 时间窗口（以 s 为单位）之内，对这个方法的调用都会自动地返回。异常比率的阈值范围是 [0.0,1.0]</li>
</ul>
<p>第1步: 首先模拟一个异常</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">int i &#x3D; 0;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;测试高并发</span><br><span class="line">@RequestMapping(&quot;&#x2F;order&#x2F;message1&quot;)</span><br><span class="line">public String msg1()&#123;</span><br><span class="line"></span><br><span class="line">    i++;</span><br><span class="line">    if (i % 3 &#x3D;&#x3D; 0) &#123;</span><br><span class="line">        throw new RuntimeException();</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;        orderServiceImpl3.message();</span><br><span class="line">    return &quot;message1&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第2步: 设置异常比例为0.25</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320150242.png" alt="image-20210320150242295"></p>
<ul>
<li>异常数：当资源近 1 分钟的异常数目超过阈值之后会进行服务降级。注意由于统计时间窗口是分钟级别的，若时间窗口小于 60s，则结束熔断状态后仍可能再进入熔断状态。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320150428.png" alt="image-20210320150428185"></p>
<p>问题：</p>
<p>流控规则和降级规则返回的异常页面是一样的，我们怎么来区分到底是什么原因导致的呢？</p>
<h3 id="4-6-3-热点规则"><a href="#4-6-3-热点规则" class="headerlink" title="4.6.3  热点规则"></a>4.6.3  热点规则</h3><p>热点参数流控规则是一种更细粒度的流控规则, 它允许将规则具体到参数上。</p>
<h5 id="热点规则简单使用"><a href="#热点规则简单使用" class="headerlink" title="热点规则简单使用"></a>热点规则简单使用</h5><p>第1步: 编写代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;&#x2F;order&#x2F;message3&quot;)</span><br><span class="line">    @SentinelResource(&quot;message3&quot;)</span><br><span class="line">    public String msg3(String name,Integer age)&#123;</span><br><span class="line">        return &quot;message3&quot;+name+age;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>第2步: 配置热点规则</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320152439.png" alt="image-20210320152438916"></p>
<p>第3步: 分别用两个参数访问,会发现只对第二个参数限流了</p>
<h5 id="热点规则增强使用"><a href="#热点规则增强使用" class="headerlink" title="热点规则增强使用"></a>热点规则增强使用</h5><p>参数例外项允许对一个参数的具体值进行流控编辑刚才定义的规则,增加参数例外项</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320152541.png" alt="image-20210320152541638"></p>
<h3 id="4-6-4-授权规则"><a href="#4-6-4-授权规则" class="headerlink" title="4.6.4  授权规则"></a>4.6.4  授权规则</h3><p>很多时候，我们需要根据调用来源来判断该次请求是否允许放行，这时候可以使用 Sentinel 的来源访问控制的功能。来源访问控制根据资源的请求来源（origin）限制资源是否通过：</p>
<ul>
<li><p>若配置白名单，则只有请求来源位于白名单内时才可通过</p>
</li>
<li><p>若配置黑名单，则请求来源位于黑名单时不通过，其余的请求通过</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320153517.png" alt="image-20210320153517085"></p>
<p>上面的资源名和授权类型不难理解，但是流控应用怎么填写呢？</p>
<p>其实这个位置要填写的是来源标识，Sentinel提供了RequestOriginParser接口来处理来源</p>
<p>只要Sentinel保护的接口资源被访问，Sentinel就会调用RequestOriginParser的实现类去解析访问来源。</p>
<p>第1步: 自定义来源处理规则</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class RequestOriginParserDefinition implements RequestOriginParser &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;定义区分来源：本质作用是通过request域获取到来源标识</span><br><span class="line">    &#x2F;&#x2F; app pc</span><br><span class="line">    &#x2F;&#x2F;然后交给流控应用 进行匹配</span><br><span class="line">    @Override</span><br><span class="line">    public String parseOrigin(HttpServletRequest httpServletRequest) &#123;</span><br><span class="line">        String serviceName &#x3D; httpServletRequest.getParameter(&quot;serviceName&quot;);</span><br><span class="line">        if (StringUtils.isEmpty(serviceName)) &#123;</span><br><span class="line">            throw new RuntimeException(&quot;serviceName is Empty&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return serviceName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>第2步: 授权规则配置</p>
<p>这个配置的意思是只有serviceName=pc不能访问(黑名单)</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320153714.png" alt="image-20210320153714373"></p>
<h3 id="4-6-5-系统规则"><a href="#4-6-5-系统规则" class="headerlink" title="4.6.5  系统规则"></a>4.6.5  系统规则</h3><p>系统保护规则是从应用级别的入口流量进行控制，从单台机器的总体 Load、RT、入口 QPS 、CPU 使用率和线程数五个维度监控应用数据，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p>
<p>系统保护规则是应用整体维度的，而不是资源维度的，并且仅对入口流量 (进入应用的流量) 生效。</p>
<ul>
<li>Load（仅对 Linux/Unix-like 机器生效）：当系统 load1 超过阈值，且系统当前的并发线程数超过系统容量时才会触发系统保护。系统容量由系统的 maxQps * minRt 计算得出。设定参考值一般 是 CPU cores * 2.5。</li>
<li>RT：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。</li>
<li>线程数：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护</li>
<li>入口 QPS：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护</li>
<li>CPU使用率：当单台机器上所有入口流量的 CPU使用率达到阈值即触发系统保护</li>
</ul>
<p><strong>扩展</strong>:自定义异常返回</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;20&#x2F;</span><br><span class="line"> * @Description:自定义异常处理页面</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Component</span><br><span class="line">public class ExceptionHandlerPage implements UrlBlockHandler &#123;</span><br><span class="line">    &#x2F;&#x2F;BlockException 异常接口,包含Sentinel的五个异常</span><br><span class="line">    &#x2F;&#x2F; FlowException 限流异常</span><br><span class="line">    &#x2F;&#x2F; DegradeException 降级异常</span><br><span class="line">    &#x2F;&#x2F; ParamFlowException 参数限流异常</span><br><span class="line">    &#x2F;&#x2F; AuthorityException 授权异常</span><br><span class="line">    &#x2F;&#x2F; SystemBlockException 系统负载异常</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void blocked(HttpServletRequest request, HttpServletResponse response, BlockException e) throws IOException &#123;</span><br><span class="line">        response.setContentType(&quot;application&#x2F;json;charset&#x3D;utf-8&quot;);</span><br><span class="line">        ResponseData responseData &#x3D; null;</span><br><span class="line">        if (e instanceof FlowException) &#123;</span><br><span class="line">            responseData &#x3D; new ResponseData(-1,&quot;接口限流&#x3D;&#x3D;&#x3D;&quot;);</span><br><span class="line">        &#125; else if (e instanceof DegradeException) &#123;</span><br><span class="line">            responseData &#x3D; new ResponseData(-2,&quot;接口降级&#x3D;&#x3D;&#x3D;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        response.getWriter().write(JSON.toJSONString(responseData));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Data</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">@NoArgsConstructor</span><br><span class="line">class ResponseData &#123;</span><br><span class="line">    private int code;</span><br><span class="line">    private String message;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-7-SentinelResource的使用"><a href="#4-7-SentinelResource的使用" class="headerlink" title="4.7  @SentinelResource的使用"></a>4.7  @SentinelResource的使用</h2><p>在定义了资源点之后，我们可以通过Dashboard来设置限流和降级策略来对资源点进行保护。同时还能  通过@SentinelResource来指定出现异常时的处理策略。</p>
<p>@SentinelResource用于定义资源，并提供可选的异常处理和 fallback 配置项。其主要参数如下：</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>作用</strong></th>
</tr>
</thead>
<tbody><tr>
<td>value</td>
<td>资源名称</td>
</tr>
<tr>
<td>entryType</td>
<td>entry类型，标记流量的方向，取值IN/OUT，默认是OUT</td>
</tr>
<tr>
<td>blockHandler</td>
<td>处理BlockException的函数名称,函数要求：  1. 必须是 public  2.返回类型 参数与原方法一致  3. 默认需和原方法在同一个类中。若希望使用其他类的函数，可配置  blockHandlerClass ，并指定blockHandlerClass里面的方法。</td>
</tr>
<tr>
<td>blockHandlerClass</td>
<td>存放blockHandler的类,对应的处理函数必须static修饰。</td>
</tr>
<tr>
<td>fallback</td>
<td>用于在抛出异常的时候提供fallback处理逻辑。fallback函数可以针对所有类型的异常（除了 exceptionsToIgnore 里面排除掉的异常类型）进行处理。函数要求：  1. 返回类型与原方法一致  2. 参数类型需要和原方法相匹配  3. 默认需和原方法在同一个类中。若希望使用其他类的函数，可配置  fallbackClass ，并指定fallbackClass里面的方法。</td>
</tr>
<tr>
<td>fallbackClass</td>
<td>存放fallback的类。对应的处理函数必须static修饰。</td>
</tr>
<tr>
<td>defaultFallback</td>
<td>用于通用的 fallback 逻辑。默认fallback函数可以针对所有类型的异常进行处理。若同时配置了 fallback 和 defaultFallback，以fallback为准。函数要求：  1. 返回类型与原方法一致  2. 方法参数列表为空，或者有一个 Throwable 类型的参数。  3. 默认需要和原方法在同一个类中。若希望使用其他类的函数，可配置  fallbackClass ，并指定 fallbackClass 里面的方法。</td>
</tr>
<tr>
<td>exceptionsToIgnore</td>
<td>指定排除掉哪些异常。排除的异常不会计入异常统计，也不会进入  fallback逻辑，而是原样抛出。</td>
</tr>
<tr>
<td>exceptionsToTrace</td>
<td>需要trace的异常</td>
</tr>
</tbody></table>
<h3 id="定义限流和降级后的处理方法"><a href="#定义限流和降级后的处理方法" class="headerlink" title="定义限流和降级后的处理方法"></a>定义限流和降级后的处理方法</h3><p>方式一：直接将限流和降级方法定义在方法中</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Service</span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderServiceImpl3 &#123;</span><br><span class="line"></span><br><span class="line">    int i &#x3D; 0;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;定义资源，指定资源名</span><br><span class="line">    &#x2F;&#x2F;定义当资源内部发生异常的时候的处理逻辑</span><br><span class="line">    &#x2F;&#x2F;blockHandler 定义当资源内部发生了BlockException应该进入的方法【捕获的是sentinel的异常】</span><br><span class="line">    &#x2F;&#x2F;fallback 定义当资源内部发生了Throwable应该进入的方法</span><br><span class="line">    @SentinelResource(value &#x3D; &quot;message&quot;,</span><br><span class="line">            blockHandler &#x3D; &quot;blockHandler&quot;,</span><br><span class="line">            fallback &#x3D; &quot;fallback&quot;</span><br><span class="line">    )</span><br><span class="line">    public String message(String name)&#123;</span><br><span class="line">        i++;</span><br><span class="line">        if (i % 3 &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            throw new RuntimeException();</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;message&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	 &#x2F;&#x2F;blockHandler</span><br><span class="line">    &#x2F;&#x2F;要求：</span><br><span class="line">    &#x2F;&#x2F;1.当前方法的返回值和参数要跟原方法一致</span><br><span class="line">    &#x2F;&#x2F;2.但是允许在参数列表的最后加入一个参数BlockException,用来接收原方法中发生的异常</span><br><span class="line">    public  String blockHandler(String name, BlockException e)&#123;</span><br><span class="line">        &#x2F;&#x2F;自定义异常逻辑</span><br><span class="line">        log.error(&quot;触发了BlockException，为&#123;&#125;&quot;,e);</span><br><span class="line">        return &quot;BlockException&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">      &#x2F;&#x2F;fallback</span><br><span class="line">    &#x2F;&#x2F;要求：</span><br><span class="line">    &#x2F;&#x2F;1.当前方法的返回值和参数要跟原方法一致</span><br><span class="line">    &#x2F;&#x2F;2.但是允许在参数列表的最后加入一个参数Throwable,用来接收原方法中发生的异常</span><br><span class="line">    public  String fallback(String name, Throwable e)&#123;</span><br><span class="line">        &#x2F;&#x2F;自定义异常逻辑</span><br><span class="line">        log.error(&quot;触发了Throwable，为&#123;&#125;&quot;,e);</span><br><span class="line">        return &quot;Throwable&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方式二: 将限流和降级方法外置到单独的类中</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Service</span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderServiceImpl3 &#123;</span><br><span class="line"></span><br><span class="line">    int i &#x3D; 0;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;定义资源，指定资源名</span><br><span class="line">    &#x2F;&#x2F;定义当资源内部发生异常的时候的处理逻辑</span><br><span class="line">    &#x2F;&#x2F;blockHandler 定义当资源内部发生了BlockException应该进入的方法【捕获的是sentinel的异常】</span><br><span class="line">    &#x2F;&#x2F;fallback 定义当资源内部发生了Throwable应该进入的方法</span><br><span class="line">    @SentinelResource(value &#x3D; &quot;message&quot;,</span><br><span class="line">            blockHandlerClass &#x3D; OrderServiceImpl3BlockHandler.class,</span><br><span class="line">            blockHandler &#x3D; &quot;blockHandler&quot;,</span><br><span class="line">            fallbackClass &#x3D; OrderServiceImpl3Fallback.class,</span><br><span class="line">            fallback &#x3D; &quot;fallback&quot;</span><br><span class="line">    )</span><br><span class="line">    public String message(String name)&#123;</span><br><span class="line">        i++;</span><br><span class="line">        if (i % 3 &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            throw new RuntimeException();</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;message&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderServiceImpl3BlockHandler &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;blockHandler</span><br><span class="line">    &#x2F;&#x2F;要求：</span><br><span class="line">    &#x2F;&#x2F;1.当前方法的返回值和参数要跟原方法一致</span><br><span class="line">    &#x2F;&#x2F;2.但是允许在参数列表的最后加入一个参数BlockException,用来接收原方法中发生的异常</span><br><span class="line">    public static String blockHandler(String name, BlockException e)&#123;</span><br><span class="line">        &#x2F;&#x2F;自定义异常逻辑</span><br><span class="line">        log.error(&quot;触发了BlockException，为&#123;&#125;&quot;,e);</span><br><span class="line">        return &quot;BlockException&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderServiceImpl3Fallback &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;fallback</span><br><span class="line">    &#x2F;&#x2F;要求：</span><br><span class="line">    &#x2F;&#x2F;1.当前方法的返回值和参数要跟原方法一致</span><br><span class="line">    &#x2F;&#x2F;2.但是允许在参数列表的最后加入一个参数Throwable,用来接收原方法中发生的异常</span><br><span class="line">    public static String fallback(String name, Throwable e)&#123;</span><br><span class="line">        &#x2F;&#x2F;自定义异常逻辑</span><br><span class="line">        log.error(&quot;触发了Throwable，为&#123;&#125;&quot;,e);</span><br><span class="line">        return &quot;Throwable&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="4-8-Sentinel规则持久化"><a href="#4-8-Sentinel规则持久化" class="headerlink" title="4.8  Sentinel规则持久化"></a>4.8  Sentinel规则持久化</h2><p>通过前面的讲解，我们已经知道，可以通过Dashboard来为每个Sentinel客户端设置各种各样的规  则，但是这里有一个问题，就是这些规则默认是存放在内存中，极不稳定，所以需要将其持久化。</p>
<p>本地文件数据源会定时轮询文件的变更，读取规则。这样我们既可以在应用本地直接修改文件来更 新规则，也可以通过 Sentinel 控制台推送规则。以本地文件数据源为例，推送过程如下图所示：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320213421.png" alt="image-20210320213421590"></p>
<p>首先 Sentinel 控制台通过 API 将规则推送至客户端并更新到内存中，接着注册的写数据源会将新的规则保存到本地的文件中。</p>
<p>1 编写处理类</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.wb.order.config;</span><br><span class="line"></span><br><span class="line">import com.alibaba.csp.sentinel.command.handler.ModifyParamFlowRulesCommandHandler;</span><br><span class="line">import com.alibaba.csp.sentinel.datasource.*;</span><br><span class="line">import com.alibaba.csp.sentinel.init.InitFunc;</span><br><span class="line">import com.alibaba.csp.sentinel.slots.block.authority.AuthorityRule;</span><br><span class="line">import com.alibaba.csp.sentinel.slots.block.authority.AuthorityRuleManager;</span><br><span class="line">import com.alibaba.csp.sentinel.slots.block.degrade.DegradeRule;</span><br><span class="line">import com.alibaba.csp.sentinel.slots.block.degrade.DegradeRuleManager;</span><br><span class="line">import com.alibaba.csp.sentinel.slots.block.flow.FlowRule;</span><br><span class="line">import com.alibaba.csp.sentinel.slots.block.flow.FlowRuleManager;</span><br><span class="line">import com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowRule;</span><br><span class="line">import com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowRuleManager;</span><br><span class="line">import com.alibaba.csp.sentinel.slots.system.SystemRule;</span><br><span class="line">import com.alibaba.csp.sentinel.slots.system.SystemRuleManager;</span><br><span class="line">import com.alibaba.csp.sentinel.transport.util.WritableDataSourceRegistry;</span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.alibaba.fastjson.TypeReference;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line"></span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;20&#x2F;</span><br><span class="line"> * @Description: 规则持久化</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class FilePersistence implements InitFunc &#123;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;spring.application.name&quot;)</span><br><span class="line">    private String appcationName;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void init() throws Exception &#123;</span><br><span class="line">        String ruleDir &#x3D; System.getProperty(&quot;user.home&quot;) + &quot;&#x2F;sentinel-rules&#x2F;&quot; + appcationName;</span><br><span class="line">        String flowRulePath &#x3D; ruleDir + &quot;&#x2F;flow-rule.json&quot;;</span><br><span class="line">        String degradeRulePath &#x3D; ruleDir + &quot;&#x2F;degrade-rule.json&quot;;</span><br><span class="line">        String systemRulePath &#x3D; ruleDir + &quot;&#x2F;system-rule.json&quot;;</span><br><span class="line">        String authorityRulePath &#x3D; ruleDir + &quot;&#x2F;authority-rule.json&quot;;</span><br><span class="line">        String paramFlowRulePath &#x3D; ruleDir + &quot;&#x2F;param-flow-rule.json&quot;;</span><br><span class="line"></span><br><span class="line">        this.mkdirIfNotExits(ruleDir);</span><br><span class="line">        this.createFileIfNotExits(flowRulePath);</span><br><span class="line">        this.createFileIfNotExits(degradeRulePath);</span><br><span class="line">        this.createFileIfNotExits(systemRulePath);</span><br><span class="line">        this.createFileIfNotExits(authorityRulePath);</span><br><span class="line">        this.createFileIfNotExits(paramFlowRulePath);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 流控规则</span><br><span class="line">        ReadableDataSource&lt;String, List&lt;FlowRule&gt;&gt; flowRuleRDS &#x3D; new FileRefreshableDataSource&lt;&gt;(</span><br><span class="line">                flowRulePath,</span><br><span class="line">                flowRuleListParser</span><br><span class="line">        );</span><br><span class="line">        FlowRuleManager.register2Property(flowRuleRDS.getProperty());</span><br><span class="line">        WritableDataSource&lt;List&lt;FlowRule&gt;&gt; flowRuleWDS &#x3D; new FileWritableDataSource&lt;&gt;(</span><br><span class="line">                flowRulePath,</span><br><span class="line">                this::encodeJson</span><br><span class="line">        );</span><br><span class="line">        WritableDataSourceRegistry.registerFlowDataSource(flowRuleWDS);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 降级规则</span><br><span class="line">        ReadableDataSource&lt;String, List&lt;DegradeRule&gt;&gt; degradeRuleRDS &#x3D; new FileRefreshableDataSource&lt;&gt;(</span><br><span class="line">                degradeRulePath,</span><br><span class="line">                degradeRuleListParser</span><br><span class="line">        );</span><br><span class="line">        DegradeRuleManager.register2Property(degradeRuleRDS.getProperty());</span><br><span class="line">        WritableDataSource&lt;List&lt;DegradeRule&gt;&gt; degradeRuleWDS &#x3D; new FileWritableDataSource&lt;&gt;(</span><br><span class="line">                degradeRulePath,</span><br><span class="line">                this::encodeJson</span><br><span class="line">        );</span><br><span class="line">        WritableDataSourceRegistry.registerDegradeDataSource(degradeRuleWDS);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 系统规则</span><br><span class="line">        ReadableDataSource&lt;String, List&lt;SystemRule&gt;&gt; systemRuleRDS &#x3D; new FileRefreshableDataSource&lt;&gt;(</span><br><span class="line">                systemRulePath,</span><br><span class="line">                systemRuleListParser</span><br><span class="line">        );</span><br><span class="line">        SystemRuleManager.register2Property(systemRuleRDS.getProperty());</span><br><span class="line">        WritableDataSource&lt;List&lt;SystemRule&gt;&gt; systemRuleWDS &#x3D; new FileWritableDataSource&lt;&gt;(</span><br><span class="line">                systemRulePath,</span><br><span class="line">                this::encodeJson</span><br><span class="line">        );</span><br><span class="line">        WritableDataSourceRegistry.registerSystemDataSource(systemRuleWDS);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 授权规则</span><br><span class="line">        ReadableDataSource&lt;String, List&lt;AuthorityRule&gt;&gt; authorityRuleRDS &#x3D; new FileRefreshableDataSource&lt;&gt;(</span><br><span class="line">                authorityRulePath,</span><br><span class="line">                authorityRuleListParser</span><br><span class="line">        );</span><br><span class="line">        AuthorityRuleManager.register2Property(authorityRuleRDS.getProperty());</span><br><span class="line">        WritableDataSource&lt;List&lt;AuthorityRule&gt;&gt; authorityRuleWDS &#x3D; new FileWritableDataSource&lt;&gt;(</span><br><span class="line">                authorityRulePath,</span><br><span class="line">                this::encodeJson</span><br><span class="line">        );</span><br><span class="line">        WritableDataSourceRegistry.registerAuthorityDataSource(authorityRuleWDS);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 热点参数规则</span><br><span class="line">        ReadableDataSource&lt;String, List&lt;ParamFlowRule&gt;&gt; paramFlowRuleRDS &#x3D; new FileRefreshableDataSource&lt;&gt;(</span><br><span class="line">                paramFlowRulePath,</span><br><span class="line">                paramFlowRuleListParser</span><br><span class="line">        );</span><br><span class="line">        ParamFlowRuleManager.register2Property(paramFlowRuleRDS.getProperty());</span><br><span class="line">        WritableDataSource&lt;List&lt;ParamFlowRule&gt;&gt; paramFlowRuleWDS &#x3D; new FileWritableDataSource&lt;&gt;(</span><br><span class="line">                paramFlowRulePath,</span><br><span class="line">                this::encodeJson</span><br><span class="line">        );</span><br><span class="line">        ModifyParamFlowRulesCommandHandler.setWritableDataSource(paramFlowRuleWDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private Converter&lt;String, List&lt;FlowRule&gt;&gt; flowRuleListParser &#x3D; source -&gt; JSON.parseObject(</span><br><span class="line">            source,</span><br><span class="line">            new TypeReference&lt;List&lt;FlowRule&gt;&gt;() &#123;</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line">    private Converter&lt;String, List&lt;DegradeRule&gt;&gt; degradeRuleListParser &#x3D; source -&gt; JSON.parseObject(</span><br><span class="line">            source,</span><br><span class="line">            new TypeReference&lt;List&lt;DegradeRule&gt;&gt;() &#123;</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line">    private Converter&lt;String, List&lt;SystemRule&gt;&gt; systemRuleListParser &#x3D; source -&gt; JSON.parseObject(</span><br><span class="line">            source,</span><br><span class="line">            new TypeReference&lt;List&lt;SystemRule&gt;&gt;() &#123;</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    private Converter&lt;String, List&lt;AuthorityRule&gt;&gt; authorityRuleListParser &#x3D; source -&gt; JSON.parseObject(</span><br><span class="line">            source,</span><br><span class="line">            new TypeReference&lt;List&lt;AuthorityRule&gt;&gt;() &#123;</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    private Converter&lt;String, List&lt;ParamFlowRule&gt;&gt; paramFlowRuleListParser &#x3D; source -&gt; JSON.parseObject(</span><br><span class="line">            source,</span><br><span class="line">            new TypeReference&lt;List&lt;ParamFlowRule&gt;&gt;() &#123;</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    private void mkdirIfNotExits(String filePath) throws IOException &#123;</span><br><span class="line">        File file &#x3D; new File(filePath);</span><br><span class="line">        if (!file.exists()) &#123;</span><br><span class="line">            file.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void createFileIfNotExits(String filePath) throws IOException &#123;</span><br><span class="line">        File file &#x3D; new File(filePath);</span><br><span class="line">        if (!file.exists()) &#123;</span><br><span class="line">            file.createNewFile();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private &lt;T&gt; String encodeJson(T t) &#123;</span><br><span class="line">        return JSON.toJSONString(t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>2 添加配置</p>
<p>在resources下创建配置目录META-INF/services,然后添加文件</p>
<p>com.alibaba.csp.sentinel.init.InitFunc</p>
<p>在文件中添加配置类的全路径: com.wb.order.config.FilePersistence</p>
<h2 id="4-9-Feign整合Sentinel"><a href="#4-9-Feign整合Sentinel" class="headerlink" title="4.9  Feign整合Sentinel"></a>4.9  Feign整合Sentinel</h2><p>第1步: 引入sentinel的依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--sentinel客户端--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p>第2步: 在配置文件中开启Feign对Sentinel的支持</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">feign:</span><br><span class="line">	sentinel:</span><br><span class="line">		enabled: true</span><br></pre></td></tr></table></figure>
<p> 第3步: 创建容错类</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;20&#x2F;</span><br><span class="line"> * @Description: 这是一个容错类，需要实现fegin所在的接口及其中的方法</span><br><span class="line"> * fegin远程调用出问题，就会进入此类中对应的方法</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Service</span><br><span class="line">public class ProductFeginFallback implements ProductFeginService &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public Product findProductById(Integer pid) &#123;</span><br><span class="line">        &#x2F;&#x2F;容错逻辑</span><br><span class="line">        Product product &#x3D; new Product();</span><br><span class="line">        product.setPid(-100);</span><br><span class="line">        product.setPname(&quot;远程调用失败&quot;);</span><br><span class="line">        return product;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第4步: 为被容器的接口指定容错类</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;15&#x2F;</span><br><span class="line"> * @Description:</span><br><span class="line"> * value指定调用nacos哪个服务</span><br><span class="line"> * fallback指定当前接口的容错类</span><br><span class="line"> *&#x2F;</span><br><span class="line">@FeignClient(value &#x3D; &quot;service-product&quot;,fallback &#x3D; ProductFeginFallback.class)</span><br><span class="line">public interface ProductFeginService &#123;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;&#x2F;product&#x2F;&#123;pid&#125;&quot;)</span><br><span class="line">    Product findProductById(@PathVariable(&quot;pid&quot;) Integer pid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第5步: 修改controller</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;14&#x2F;</span><br><span class="line"> * @Description:</span><br><span class="line"> *&#x2F;</span><br><span class="line">@RestController</span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderController &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RestTemplate restTemplate;</span><br><span class="line">    @Autowired</span><br><span class="line">    private OrderService orderService;</span><br><span class="line">    @Autowired</span><br><span class="line">    private DiscoveryClient discoveryClient;</span><br><span class="line">    @Autowired</span><br><span class="line">    private ProductFeginService productFeginService;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;&#x2F;order&#x2F;prod&#x2F;&#123;pid&#125;&quot;)</span><br><span class="line">    public Order saveOrder(@PathVariable(&quot;pid&quot;)Integer pid)&#123;</span><br><span class="line">        &#x2F;&#x2F;Fegin</span><br><span class="line">        log.info(&quot;接收到&#123;&#125;号商品下单请求，调用商品微服务查询信息&quot;,pid);</span><br><span class="line"></span><br><span class="line">        Product product &#x3D;productFeginService.findProductById(pid);</span><br><span class="line"></span><br><span class="line">        if (product.getPid() &#x3D;&#x3D; -100) &#123;</span><br><span class="line">            Order order &#x3D; new Order();</span><br><span class="line">            order.setPid(-100);</span><br><span class="line">            order.setPname(&quot;下单失败&quot;);</span><br><span class="line">            return order;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.info(&quot;查询到的商品为：&#123;&#125;&quot;+ JSON.toJSONString(product));</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;创建订单</span><br><span class="line">        Order order &#x3D; new Order();</span><br><span class="line">        order.setUid(1);</span><br><span class="line">        order.setUsername(&quot;蜡笔小新&quot;);</span><br><span class="line"></span><br><span class="line">        order.setPid(product.getPid());</span><br><span class="line">        order.setPname(product.getPname());</span><br><span class="line">        order.setPprice(product.getPprice());</span><br><span class="line"></span><br><span class="line">        order.setNumber(10);</span><br><span class="line"></span><br><span class="line">        orderService.createOrder(order);</span><br><span class="line"></span><br><span class="line">        log.info(&quot;创建订单成功，订单为：&#123;&#125;&quot;+ JSON.toJSONString(order));</span><br><span class="line"></span><br><span class="line">        return order;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第6步: 停止所有shop-product服务，访问/order/prod/{pid}，观察容错效果</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320220503.png" alt="image-20210320220503077"></p>
<p><strong>扩展</strong>: 如果想在容错类中拿到具体的错误,可以使用下面的方式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">@Service</span><br><span class="line">public class ProductFeginFallbackFactory implements FallbackFactory&lt;ProductFeginService&gt; &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ProductFeginService create(Throwable cause) &#123;</span><br><span class="line">        return new ProductFeginService() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Product findProductById(Integer pid) &#123;</span><br><span class="line"></span><br><span class="line">                log.error(&quot;&#123;&#125;&quot;,cause);</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F;容错逻辑</span><br><span class="line">                Product product &#x3D; new Product();</span><br><span class="line">                product.setPid(-100);</span><br><span class="line">                product.setPname(&quot;远程调用失败&quot;);</span><br><span class="line">                return product;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@FeignClient(value &#x3D; &quot;service-product&quot;,</span><br><span class="line">&#x2F;&#x2F;        fallback &#x3D; ProductFeginFallback.class,</span><br><span class="line">        fallbackFactory &#x3D; ProductFeginFallbackFactory.class</span><br><span class="line">)</span><br><span class="line">public interface ProductFeginService &#123;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;&#x2F;product&#x2F;&#123;pid&#125;&quot;)</span><br><span class="line">    Product findProductById(@PathVariable(&quot;pid&quot;) Integer pid);</span><br><span class="line">&#125;</span><br><span class="line">注意: fallback和fallbackFactory只能使用其中一种方式</span><br></pre></td></tr></table></figure>
<h1 id="第五章-Gateway–服务网关"><a href="#第五章-Gateway–服务网关" class="headerlink" title="第五章 Gateway–服务网关"></a>第五章 Gateway–服务网关</h1><h2 id="5-1-网关简介"><a href="#5-1-网关简介" class="headerlink" title="5.1  网关简介"></a>5.1  网关简介</h2><p>大家都都知道在微服务架构中，一个系统会被拆分为很多个微服务。那么作为客户端要如何去调用 这么多的微服务呢？如果没有网关的存在，我们只能在客户端记录每个微服务的地址，然后分别去调用。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320221453.png" alt="image-20210320221453421"></p>
<p>这样的架构，会存在着诸多的问题：</p>
<ul>
<li>客户端多次请求不同的微服务，增加客户端代码或配置编写的复杂性</li>
<li>认证复杂，每个服务都需要独立认证</li>
<li>存在跨域请求，在一定场景下处理相对复杂</li>
</ul>
<p>上面的这些问题可以借助<strong>API网关</strong>来解决</p>
<p>所谓的API网关，就是指系统的<strong>统一入口</strong>，它封装了应用程序的内部结构，为客户端提供统一服务，一些与业务本身功能无关的公共逻辑可以在这里实现，诸如认证、鉴权、监控、路由转发等等。 添加上API网关之后，系统的架构图变成了如下所示：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320221602.png" alt="image-20210320221602637"></p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210320221619.png" alt="image-20210320221618960"></p>
<p>在业界比较流行的网关，有下面这些：</p>
<ul>
<li><strong>Ngnix+lua</strong></li>
</ul>
<p>使用nginx的反向代理和负载均衡可实现对api服务器的负载均衡及高可用</p>
<p>lua是一种脚本语言,可以来编写一些简单的逻辑, nginx支持lua脚本</p>
<ul>
<li><strong>Kong</strong></li>
</ul>
<p>基于Nginx+Lua开发，性能高，稳定，有多个可用的插件(限流、鉴权等等)可以开箱即用。 问题： 只支持Http协议；二次开发，自由扩展困难；提供管理API，缺乏更易用的管控、配置方式。</p>
<ul>
<li><strong>Zuul</strong> </li>
</ul>
<p>Netﬂix开源的网关，功能丰富，使用JAVA开发，易于二次开发 问题：缺乏管控，无法动态配置；依赖组件较多；处理Http请求依赖的是Web容器，性能不如Nginx</p>
<ul>
<li><strong>Spring Cloud Gateway</strong></li>
</ul>
<p>Spring公司为了替换Zuul而开发的网关服务，将在下面具体介绍</p>
<p>注意：SpringCloud alibaba技术栈中并没有提供自己的网关，我们可以采用Spring Cloud Gateway来做网关</p>
<h2 id="5-2-Gateway简介"><a href="#5-2-Gateway简介" class="headerlink" title="5.2  Gateway简介"></a>5.2  Gateway简介</h2><p>Spring Cloud Gateway是Spring公司基于Spring 5.0，Spring Boot 2.0 和 Project Reactor 等技术开发的网关，它旨在为微服务架构提供一种简单有效的统一的 API 路由管理方式。它的目标是替代Netﬂix Zuul，其不仅提供统一的路由方式，并且基于 Filter 链的方式提供了网关基本的功能，例如：安全，监控和限流。</p>
<p><strong>优点</strong></p>
<ul>
<li>性能强劲：是第一代网关Zuul的1.6倍</li>
<li>功能强大：内置了很多实用的功能，例如转发、监控、限流等</li>
<li>设计优雅，容易扩展</li>
</ul>
<p><strong>缺点</strong></p>
<p>其实现依赖Netty与WebFlux，不是传统的Servlet编程模型，学习成本高</p>
<p>不能将其部署在Tomcat、Jetty等Servlet容器里，只能打成jar包执行</p>
<p>需要Spring Boot 2.0及以上的版本，才支持</p>
<h2 id="5-3-Gateway快速入门"><a href="#5-3-Gateway快速入门" class="headerlink" title="5.3  Gateway快速入门"></a>5.3  Gateway快速入门</h2><p>要求: 通过浏览器访问api网关,然后通过网关将请求转发到商品微服务</p>
<h3 id="5-3-1-基础版"><a href="#5-3-1-基础版" class="headerlink" title="5.3.1  基础版"></a>5.3.1  基础版</h3><p>第1步：创建一个api-gateway的模块,导入相关依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;springCloudAlibaba&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;com.wb&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;api-gateway&lt;&#x2F;artifactId&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!--gateway网关，不能跟webstarter同时存在--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-gateway&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>
<p>第二步：创建启动类</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.wb;</span><br><span class="line"></span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;03&#x2F;31&#x2F;</span><br><span class="line"> * @Description: 网关服务</span><br><span class="line"> *&#x2F;</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class GatewayApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(GatewayApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第3步: 添加配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 7000</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: api-gateway</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:  #路由数组【路由就是指当请求满足对应条件时则转发到对应的微服务上】</span><br><span class="line">        - id: product_route  #当前路由标识，唯一，默认UUID</span><br><span class="line">          uri: http:&#x2F;&#x2F;localhost:8081 #请求最终转发地址</span><br><span class="line">          order: 1 #路由的优先级，数字越小，优先级越大</span><br><span class="line">          predicates: #断言（条件判断，返回值boolean，转发请求要满足的条件）</span><br><span class="line">            - Path&#x3D;&#x2F;product-serv&#x2F;** #当请求路径满足path指定的规则，才生效</span><br><span class="line">          filters: #过滤器（请求传递过程中，对请求做一些手脚）</span><br><span class="line">            - StripPrefix&#x3D;1 #请求转发之前去掉一层路径</span><br></pre></td></tr></table></figure>
<p>第4步: 启动项目, 并通过网关去访问微服务</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210331233635.png" alt="image-20210331233635739"></p>
<h3 id="5-3-2-增强版"><a href="#5-3-2-增强版" class="headerlink" title="5.3.2  增强版"></a>5.3.2  增强版</h3><p>现在在配置文件中写死了转发路径的地址, 前面我们已经分析过地址写死带来的问题, 接下来我们从注册中心获取此地址。</p>
<p>第1步：加入nacos依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--nacos--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;com.alibaba.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p>第2步：在主类上添加注解</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">public class GatewayApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(GatewayApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第3步：修改配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 7000</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: api-gateway</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: localhost:8848</span><br><span class="line">    gateway:</span><br><span class="line">      discovery:</span><br><span class="line">        locator:</span><br><span class="line">          enabled: true   #让gateway可以发现nacos中的微服务</span><br><span class="line">      routes:  #路由数组【路由就是指当请求满足对应条件时则转发到对应的微服务上】</span><br><span class="line">        - id: product_route  #当前路由标识，唯一，默认UUID</span><br><span class="line">#          uri: http:&#x2F;&#x2F;localhost:8081 #请求最终转发地址</span><br><span class="line">          uri: lb:&#x2F;&#x2F;service-product # lb指的是从nacos中按照名称获取微服务,并遵循负载均衡策略</span><br><span class="line">          order: 1 #路由的优先级，数字越小，优先级越大</span><br><span class="line">          predicates: #断言（条件判断，返回值boolean，转发请求要满足的条件）</span><br><span class="line">            - Path&#x3D;&#x2F;product-serv&#x2F;** #当请求路径满足path指定的规则，才生效</span><br><span class="line">          filters: #过滤器（请求传递过程中，对请求做一些手脚）</span><br><span class="line">            - StripPrefix&#x3D;1 #请求转发之前去掉一层路径</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210407220351.png" alt="image-20210407220351295"></p>
<h3 id="5-3-3-简写版"><a href="#5-3-3-简写版" class="headerlink" title="5.3.3  简写版"></a>5.3.3  简写版</h3><p>第1步: 去掉关于路由的配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 7000</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: api-gateway</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: localhost:8848</span><br><span class="line">    gateway:</span><br><span class="line">      discovery:</span><br><span class="line">        locator:</span><br><span class="line">          enabled: true   #让gateway可以发现nacos中的微服务</span><br></pre></td></tr></table></figure>
<p>第2步: 启动项目，并通过网关去访问微服务</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210407220651.png" alt="image-20210407220650888"></p>
<h2 id="5-4-Gateway核心架构"><a href="#5-4-Gateway核心架构" class="headerlink" title="5.4  Gateway核心架构"></a>5.4  Gateway核心架构</h2><h3 id="5-4-1基本概念"><a href="#5-4-1基本概念" class="headerlink" title="5.4.1基本概念"></a>5.4.1基本概念</h3><p>路由(Route) 是 gateway 中最基本的组件之一，表示一个具体的路由信息载体。主要定义了下面的几个信息:</p>
<ul>
<li><strong>id</strong>，路由标识符，区别于其他 Route</li>
<li><strong>uri</strong>，路由指向的目的地       uri，即客户端请求最终被转发到的微服务</li>
<li><strong>order</strong>，用于多个 Route 之间的排序，数值越小排序越靠前，匹配优先级越高</li>
<li><strong>predicate</strong>，断言的作用是进行条件判断，只有断言都返回真，才会真正的执行路由</li>
<li><strong>ﬁlter</strong>，过滤器用于修改请求和响应信息。</li>
</ul>
<h3 id="5-4-2-执行流程"><a href="#5-4-2-执行流程" class="headerlink" title="5.4.2  执行流程"></a>5.4.2  执行流程</h3><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210407220939.png" alt="image-20210407220939286"></p>
<p>执行流程大体如下：</p>
<ol>
<li><p>Gateway Client向Gateway Server发送请求</p>
</li>
<li><p>请求首先会被HttpWebHandlerAdapter进行提取组装成网关上下文</p>
</li>
<li><p>然后网关的上下文会传递到DispatcherHandler，它负责将请求分发给RoutePredicateHandlerMapping</p>
</li>
<li><p>RoutePredicateHandlerMapping负责路由查找，并根据路由断言判断路由是否可用</p>
</li>
<li><p>如果过断言成功，由FilteringWebHandler创建过滤器链并调用</p>
</li>
<li><p>请求会一次经过PreFilter–微服务–PostFilter的方法，最终返回响应</p>
</li>
</ol>
<h2 id="5-5-断言"><a href="#5-5-断言" class="headerlink" title="5.5  断言"></a>5.5  断言</h2><p>Predicate(断言, 谓词) 用于进行条件判断，只有断言都返回真，才会真正的执行路由。断言就是说: 在 <strong>什么条件下</strong> 才能进行路由转发</p>
<h3 id="5-5-1-内置路由断言工厂"><a href="#5-5-1-内置路由断言工厂" class="headerlink" title="5.5.1  内置路由断言工厂"></a>5.5.1  内置路由断言工厂</h3><p>SpringCloud  Gateway包括许多内置的断言工厂，所有这些断言都与HTTP请求的不同属性匹配。具体如下：</p>
<ul>
<li>基于Datetime类型的断言工厂</li>
</ul>
<p>此类型的断言根据时间做判断，主要有三个：</p>
<p>AfterRoutePredicateFactory： 接收一个日期参数，判断请求日期是否晚于指定日期</p>
<p>BeforeRoutePredicateFactory： 接收一个日期参数，判断请求日期是否早于指定日期</p>
<p>BetweenRoutePredicateFactory： 接收两个日期参数，判断请求日期是否在指定时间段内</p>
<p>-After=2019-12-31T23:59:59.789+08:00[Asia/Shanghai]</p>
<ul>
<li>基于远程地址的断言工厂  RemoteAddrRoutePredicateFactory：接收一个IP地址段，判断请求主机地址是否在地址段中</li>
</ul>
<p>-RemoteAddr=192.168.1.1/24</p>
<ul>
<li>基于Cookie的断言工厂</li>
</ul>
<p>CookieRoutePredicateFactory：接收两个参数，cookie 名字和一个正则表达式。 判断请求cookie是否具有给定名称且值与正则表达式匹配。</p>
<p>-Cookie=chocolate, ch</p>
<ul>
<li>基于Header的断言工厂</li>
</ul>
<p>HeaderRoutePredicateFactory：接收两个参数，标题名称和正则表达式。  判断请求Header是否具有给定名称且值与正则表达式匹配。</p>
<p>-Header=X-Request-Id, \d+</p>
<ul>
<li>基于Host的断言工厂</li>
</ul>
<p>HostRoutePredicateFactory：接收一个参数，主机名模式。判断请求的Host是否满足匹配规则。</p>
<p>-Host=**.testhost.org</p>
<ul>
<li>基于Method请求方法的断言工厂</li>
</ul>
<p>MethodRoutePredicateFactory：接收一个参数，判断请求类型是否跟指定的类型匹配</p>
<p>-Method=GET</p>
<ul>
<li>基于Path请求路径的断言工厂</li>
</ul>
<p>PathRoutePredicateFactory：接收一个参数，判断请求的URI部分是否满足路径规则</p>
<p>-Path=/foo/{segment}</p>
<ul>
<li>基于Query请求参数的断言工厂</li>
</ul>
<p>QueryRoutePredicateFactory ：接收两个参数，请求param和正则表达式， 判断请求参数是否具有给定名称且值与正则表达式匹配。</p>
<p>-Query=baz, ba</p>
<ul>
<li>基于路由权重的断言工厂</li>
</ul>
<p>WeightRoutePredicateFactory：接收一个[组名,权重], 然后对于同一个组内的路由按照权重转发</p>
<p>routes:</p>
<p>-id: weight_route1 uri: host1 predicates:</p>
<p>-Path=/product/**</p>
<p>-Weight=group3, 1</p>
<p>-id: weight_route2 uri: host2 predicates:</p>
<p>-Path=/product/**</p>
<p>-Weight= group3, 9</p>
<h5 id="内置路由断言工厂的使用"><a href="#内置路由断言工厂的使用" class="headerlink" title="内置路由断言工厂的使用"></a>内置路由断言工厂的使用</h5><p>接下来我们验证几个内置断言的使用:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 7000</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: api-gateway</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: localhost:8848</span><br><span class="line">    gateway:</span><br><span class="line">      discovery:</span><br><span class="line">        locator:</span><br><span class="line">          enabled: true   #让gateway可以发现nacos中的微服务</span><br><span class="line">      routes:  #路由数组【路由就是指当请求满足对应条件时则转发到对应的微服务上】</span><br><span class="line">        - id: product_route  #当前路由标识，唯一，默认UUID</span><br><span class="line">#          uri: http:&#x2F;&#x2F;localhost:8081 #请求最终转发地址</span><br><span class="line">          uri: lb:&#x2F;&#x2F;service-product # lb指的是从nacos中按照名称获取微服务,并遵循负载均衡策略</span><br><span class="line">          order: 1 #路由的优先级，数字越小，优先级越大</span><br><span class="line">          predicates: #断言（条件判断，返回值boolean，转发请求要满足的条件）</span><br><span class="line">            - Path&#x3D;&#x2F;product-serv&#x2F;** #当请求路径满足path指定的规则，才生效</span><br><span class="line">            - Before&#x3D;2021-11-28T00:00:00.000+08:00 #限制请求时间在2021-11-28之前</span><br><span class="line">            - Method&#x3D;POST #限制请求方式为POST</span><br><span class="line">          filters: #过滤器（请求传递过程中，对请求做一些手脚）</span><br><span class="line">            - StripPrefix&#x3D;1 #请求转发之前去掉一层路径</span><br></pre></td></tr></table></figure>
<h3 id="5-5-2-自定义路由断言工"><a href="#5-5-2-自定义路由断言工" class="headerlink" title="5.5.2  自定义路由断言工"></a>5.5.2  自定义路由断言工</h3><p>我们来设定一个场景: 假设我们的应用仅仅让age在(min,max)之间的人来访问。</p>
<p>第1步：在配置文件中,添加一个Age的断言配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 7000</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: api-gateway</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: localhost:8848</span><br><span class="line">    gateway:</span><br><span class="line">      discovery:</span><br><span class="line">        locator:</span><br><span class="line">          enabled: true   #让gateway可以发现nacos中的微服务</span><br><span class="line">      routes:  #路由数组【路由就是指当请求满足对应条件时则转发到对应的微服务上】</span><br><span class="line">        - id: product_route  #当前路由标识，唯一，默认UUID</span><br><span class="line">#          uri: http:&#x2F;&#x2F;localhost:8081 #请求最终转发地址</span><br><span class="line">          uri: lb:&#x2F;&#x2F;service-product # lb指的是从nacos中按照名称获取微服务,并遵循负载均衡策略</span><br><span class="line">          order: 1 #路由的优先级，数字越小，优先级越大</span><br><span class="line">          predicates: #断言（条件判断，返回值boolean，转发请求要满足的条件）</span><br><span class="line">            - Path&#x3D;&#x2F;product-serv&#x2F;** #当请求路径满足path指定的规则，才生效</span><br><span class="line">            - Age&#x3D;18,60   #让Age在18-60之间的访问</span><br><span class="line">#            - Before&#x3D;2021-11-28T00:00:00.000+08:00 #限制请求时间在2021-11-28之前</span><br><span class="line">#            - Method&#x3D;POST #限制请求方式为POST</span><br><span class="line">          filters: #过滤器（请求传递过程中，对请求做一些手脚）</span><br><span class="line">            - StripPrefix&#x3D;1 #请求转发之前去掉一层路径</span><br></pre></td></tr></table></figure>
<p>第2步：自定义一个断言工厂, 实现断言方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.wb.gateway.predicates;</span><br><span class="line"></span><br><span class="line">import lombok.Data;</span><br><span class="line">import lombok.NoArgsConstructor;</span><br><span class="line">import org.apache.commons.lang3.StringUtils;</span><br><span class="line">import org.springframework.cloud.gateway.handler.predicate.AbstractRoutePredicateFactory;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import org.springframework.web.server.ServerWebExchange;</span><br><span class="line"></span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.function.Predicate;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @Auther: wbnn</span><br><span class="line"> * @Date: 2021&#x2F;04&#x2F;07&#x2F;</span><br><span class="line"> * @Description:这是一个自定义路由断言工厂 1.名字必须是 配置+RoutePredicateFactory</span><br><span class="line"> * 2.必须继承AbstractRoutePredicateFactory&lt;配置类&gt;</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Component</span><br><span class="line">public class AgeRoutePredicateFactory extends AbstractRoutePredicateFactory&lt;AgeRoutePredicateFactory.Config&gt; &#123;</span><br><span class="line">    public static final String DATETIME_KEY &#x3D; &quot;datetime&quot;;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;    构造函数</span><br><span class="line">    public AgeRoutePredicateFactory() &#123;</span><br><span class="line">        super(AgeRoutePredicateFactory.Config.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;    读取配置文件中的参数值，赋值到配置类的属性上</span><br><span class="line">    public List&lt;String&gt; shortcutFieldOrder() &#123;</span><br><span class="line">&#x2F;&#x2F;        这个位置的顺序必须跟配置文件顺序一样</span><br><span class="line">        return Arrays.asList(&quot;minAge&quot;, &quot;maxAge&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;断言逻辑</span><br><span class="line">    public Predicate&lt;ServerWebExchange&gt; apply(AgeRoutePredicateFactory.Config config) &#123;</span><br><span class="line">        return new Predicate&lt;ServerWebExchange&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public boolean test(ServerWebExchange serverWebExchange) &#123;</span><br><span class="line">                &#x2F;&#x2F;1.接收前台传入的数据</span><br><span class="line">                String age &#x3D; serverWebExchange.getRequest().getQueryParams().getFirst(&quot;age&quot;);</span><br><span class="line">                &#x2F;&#x2F;2.判断是否为空</span><br><span class="line">                if (StringUtils.isNotEmpty(age)) &#123;</span><br><span class="line">                    int anInt &#x3D; Integer.parseInt(age);</span><br><span class="line">                    if (anInt &lt; config.getMaxAge() &amp;&amp; anInt &gt; config.getMinAge()) &#123;</span><br><span class="line">                        return true;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        return false;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Data</span><br><span class="line">    @NoArgsConstructor</span><br><span class="line">    public static class Config &#123;</span><br><span class="line">        private int minAge;</span><br><span class="line">        private int maxAge;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/springCloudAlibaba/20210407225849.png" alt="image-20210407225849619"></p>
<h2 id="5-6-过滤"><a href="#5-6-过滤" class="headerlink" title="5.6  过滤"></a>5.6  过滤</h2><p>三个知识点:</p>
<p>1 作用: 过滤器就是在请求的传递过程中,对请求和响应做一些手脚</p>
<p>2 生命周期: Pre Post</p>
<p>3 分类: 局部过滤器(作用在某一个路由上) 全局过滤器(作用全部路由上) </p>
<p>在Gateway中, Filter的生命周期只有两个：“pre” 和 “post”。</p>
<ul>
<li>PRE： 这种过滤器在请求被路由之前调用。我们可利用这种过滤器实现身份验证、在集群中选择请求的微服务、记录调试信息等。 </li>
<li>POST：这种过滤器在路由到微服务以后执行。这种过滤器可用来为响应添加标准的HTTP Header、收集统计信息和指标、将响应从微服务发送给客户端等。</li>
</ul>
<p>Gateway 的Filter从作用范围可分为两种: GatewayFilter与GlobalFilter。</p>
<ul>
<li>GatewayFilter：应用到单个路由或者一个分组的路由上</li>
<li>GlobalFilter：应用到所有的路由上</li>
</ul>
<h3 id="5-6-1-局部过滤器"><a href="#5-6-1-局部过滤器" class="headerlink" title="5.6.1  局部过滤器"></a>5.6.1  局部过滤器</h3><p>局部过滤器是针对单个路由的过滤器。</p>
<h4 id="5-6-1-1-内置局部过滤器"><a href="#5-6-1-1-内置局部过滤器" class="headerlink" title="5.6.1.1 内置局部过滤器"></a>5.6.1.1 内置局部过滤器</h4><p>在SpringCloud Gateway中内置了很多不同类型的网关路由过滤器。具体如下：</p>
<table>
<thead>
<tr>
<th align="center"><strong>过滤器工厂</strong></th>
<th><strong>作用</strong></th>
<th align="center"><strong>参数</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">AddRequestHeader</td>
<td>为原始请求添加Header</td>
<td align="center">Header的名称及值</td>
</tr>
<tr>
<td align="center">AddRequestParameter</td>
<td>为原始请求添加请求参数</td>
<td align="center">参数名称及值</td>
</tr>
<tr>
<td align="center">AddResponseHeader</td>
<td>为原始响应添加Header</td>
<td align="center">Header的名称及值</td>
</tr>
<tr>
<td align="center">DedupeResponseHeader</td>
<td>剔除响应头中重复的值</td>
<td align="center">需要去重的Header名称及去重策略</td>
</tr>
<tr>
<td align="center">Hystrix</td>
<td>为路由引入Hystrix的断路器保护</td>
<td align="center">HystrixCommand 的名称</td>
</tr>
<tr>
<td align="center">FallbackHeaders</td>
<td>为fallbackUri的请求头中添加具体的异常信息</td>
<td align="center">Header的名称</td>
</tr>
<tr>
<td align="center">PreﬁxPath</td>
<td>为原始请求路径添加前缀</td>
<td align="center">前缀路径</td>
</tr>
<tr>
<td align="center">PreserveHostHeader</td>
<td>为请求添加一个preserveHostHeader=true的属性，路由过滤器会检查该属性以决定是否要发送原始的Host</td>
<td align="center">无</td>
</tr>
<tr>
<td align="center">RequestRateLimiter</td>
<td>用于对请求限流，限流算法为令牌桶</td>
<td align="center">keyResolver、rateLimiter、statusCode、denyEmptyKey、emptyKeyStatus</td>
</tr>
<tr>
<td align="center">RedirectTo</td>
<td>将原始请求重定向到指定的URL</td>
<td align="center">http状态码及重定向的url</td>
</tr>
<tr>
<td align="center">RemoveHopByHopHeadersFilter</td>
<td>为原始请求删除IETF组织规定的一系列Header</td>
<td align="center">默认就会启用，可以通过配置指定仅删除哪些Header</td>
</tr>
<tr>
<td align="center">RemoveRequestHeader</td>
<td>为原始请求删除某个Header</td>
<td align="center">Header名称</td>
</tr>
<tr>
<td align="center">RemoveResponseHeader</td>
<td>为原始响应删除某个Header</td>
<td align="center">Header名称</td>
</tr>
<tr>
<td align="center">RewritePath</td>
<td>重写原始的请求路径</td>
<td align="center">原始路径正则表达式以及重写后路径的正则表达式</td>
</tr>
<tr>
<td align="center">RewriteResponseHeader</td>
<td>重写原始响应中的某个Header</td>
<td align="center">Header名称，值的正则表达式，重写后的值</td>
</tr>
<tr>
<td align="center">SaveSession</td>
<td>在转发请求之前，强制执行  WebSession::save 操作</td>
<td align="center">无</td>
</tr>
<tr>
<td align="center">secureHeaders</td>
<td>为原始响应添加一系列起安全作用的响应头</td>
<td align="center">无，支持修改这些安全响应头的值</td>
</tr>
<tr>
<td align="center">SetPath</td>
<td>修改原始的请求路径</td>
<td align="center">修改后的路径</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th><strong>过滤器工厂</strong></th>
<th><strong>作用</strong></th>
<th><strong>参数</strong></th>
</tr>
</thead>
<tbody><tr>
<td>SetResponseHeader</td>
<td>修改原始响应中某个Header的值</td>
<td>Header名称，修改后的值</td>
</tr>
<tr>
<td>SetStatus</td>
<td>修改原始响应的状态码</td>
<td>HTTP 状态码，可以是数字，也可以是字符串</td>
</tr>
<tr>
<td>StripPreﬁx</td>
<td>用于截断原始请求的路径</td>
<td>使用数字表示要截断的路径的数量</td>
</tr>
<tr>
<td>Retry</td>
<td>针对不同的响应进行重试</td>
<td>retries、statuses、methods、series</td>
</tr>
<tr>
<td>RequestSize</td>
<td>设置允许接收最大请求包的大 小。如果请求包大小超过设置的值，则返回 413 Payload Too  Large</td>
<td>请求包大小，单位为字节，默认值为5M</td>
</tr>
<tr>
<td>ModifyRequestBody</td>
<td>在转发请求之前修改原始请求体内容</td>
<td>修改后的请求体内容</td>
</tr>
<tr>
<td>ModifyResponseBody</td>
<td>修改原始响应体的内容</td>
<td>修改后的响应体内容</td>
</tr>
</tbody></table>
<p><strong>内置局部过滤器的使用</strong></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span>   <span class="comment">#让gateway可以发现nacos中的微服务</span></span><br><span class="line">      <span class="attr">routes:</span>  <span class="comment">#路由数组【路由就是指当请求满足对应条件时则转发到对应的微服务上】</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">product_route</span>  <span class="comment">#当前路由标识，唯一，默认UUID</span></span><br><span class="line"><span class="comment">#          uri: http://localhost:8081 #请求最终转发地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-product</span> <span class="comment"># lb指的是从nacos中按照名称获取微服务,并遵循负载均衡策略</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">1</span> <span class="comment">#路由的优先级，数字越小，优先级越大</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment">#断言（条件判断，返回值boolean，转发请求要满足的条件）</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/product-serv/**</span> <span class="comment">#当请求路径满足path指定的规则，才生效</span></span><br><span class="line"><span class="comment">#            - Age=18,60   #让Age在18-60之间的访问</span></span><br><span class="line"><span class="comment">#            - Before=2021-11-28T00:00:00.000+08:00 #限制请求时间在2021-11-28之前</span></span><br><span class="line"><span class="comment">#            - Method=POST #限制请求方式为POST</span></span><br><span class="line">          <span class="attr">filters:</span> <span class="comment">#过滤器（请求传递过程中，对请求做一些手脚）</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span> <span class="comment">#请求转发之前去掉一层路径</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">SetStatus=2000</span></span><br></pre></td></tr></table></figure>
<h4 id="5-6-1-2-自定义局部过滤器"><a href="#5-6-1-2-自定义局部过滤器" class="headerlink" title="5.6.1.2 自定义局部过滤器"></a>5.6.1.2 自定义局部过滤器</h4><p>第1步：在配置文件中,添加一个Log的过滤器配置</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span>   <span class="comment">#让gateway可以发现nacos中的微服务</span></span><br><span class="line">      <span class="attr">routes:</span>  <span class="comment">#路由数组【路由就是指当请求满足对应条件时则转发到对应的微服务上】</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">product_route</span>  <span class="comment">#当前路由标识，唯一，默认UUID</span></span><br><span class="line"><span class="comment">#          uri: http://localhost:8081 #请求最终转发地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-product</span> <span class="comment"># lb指的是从nacos中按照名称获取微服务,并遵循负载均衡策略</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">1</span> <span class="comment">#路由的优先级，数字越小，优先级越大</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment">#断言（条件判断，返回值boolean，转发请求要满足的条件）</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/product-serv/**</span> <span class="comment">#当请求路径满足path指定的规则，才生效</span></span><br><span class="line"><span class="comment">#            - Age=18,60   #让Age在18-60之间的访问</span></span><br><span class="line"><span class="comment">#            - Before=2021-11-28T00:00:00.000+08:00 #限制请求时间在2021-11-28之前</span></span><br><span class="line"><span class="comment">#            - Method=POST #限制请求方式为POST</span></span><br><span class="line">          <span class="attr">filters:</span> <span class="comment">#过滤器（请求传递过程中，对请求做一些手脚）</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span> <span class="comment">#请求转发之前去掉一层路径</span></span><br><span class="line"><span class="comment">#            - SetStatus=2000</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Log=true,false</span> <span class="comment">#控制日志是否开启</span></span><br></pre></td></tr></table></figure>
<p>第2步：自定义一个过滤器工厂,实现方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wb.gateway.filters;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.factory.AbstractGatewayFilterFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Auther</span>: wbnn</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/01/03/</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 自定义的局部过滤器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title">AbstractGatewayFilterFactory</span>&lt;<span class="title">LogGatewayFilterFactory</span>.<span class="title">Config</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构造函数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LogGatewayFilterFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(LogGatewayFilterFactory.Config.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取配置文件中的参数 赋值到配置类中</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">shortcutFieldOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="string">&quot;consoleLog&quot;</span>,<span class="string">&quot;cacheLog&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//过滤器逻辑</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(LogGatewayFilterFactory.Config config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> GatewayFilter() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (config.cacheLog) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;cacheLog已经开启了---&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (config.consoleLog) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;consoleLog已经开启了---&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置类 接收配置参数</span></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Boolean consoleLog;</span><br><span class="line">        <span class="keyword">private</span> Boolean cacheLog;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="5-6-2-全局过滤器"><a href="#5-6-2-全局过滤器" class="headerlink" title="5.6.2  全局过滤器"></a>5.6.2  全局过滤器</h3><p>全局过滤器作用于所有路由, 无需配置。通过全局过滤器可以实现对权限的统一校验，安全性验证等功能.</p>
<h4 id="5-6-2-1-内置全局过滤器"><a href="#5-6-2-1-内置全局过滤器" class="headerlink" title="5.6.2.1 内置全局过滤器"></a>5.6.2.1 内置全局过滤器</h4><p>SpringCloud Gateway内部也是通过一系列的内置全局过滤器对整个路由转发进行处理如下：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/mysql/20220103172419.png" alt="image-20220103172412344"></p>
<h4 id="5-6-2-2-自定义全局过滤器"><a href="#5-6-2-2-自定义全局过滤器" class="headerlink" title="5.6.2.2 自定义全局过滤器"></a>5.6.2.2 自定义全局过滤器</h4><p>内置的过滤器已经可以完成大部分的功能，但是对于企业开发的一些业务功能处理，还是需要我们 自己编写过滤器来实现的，那么我们一起通过代码的形式自定义一个过滤器，去完成统一的权限校验。</p>
<p>开发中的鉴权逻辑：</p>
<ul>
<li>当客户端第一次请求服务时，服务端对用户进行信息认证（登录）</li>
<li>认证通过，将用户信息进行加密形成token，返回给客户端，作为登录凭证 </li>
<li>以后每次请求，客户端都携带认证的token</li>
<li>服务端对token进行解密，判断是否有效</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/mysql/20220103172553.png" alt="image-20220103172553249"></p>
<p>如上图，对于验证用户是否已经登录鉴权的过程可以在网关统一检验。检验的标准就是请求中是否携带token凭证以及token的正确性。</p>
<p>下面的我们自定义一个GlobalFilter，去校验所有请求的请求参数中是否包含“token”，如何不包含请求</p>
<p>参数“token”则不转发路由，否则执行正常的逻辑。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wb.gateway.filters;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Auther</span>: wbnn</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/01/03/</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 自定义全局过滤器 实现统一鉴权</span></span><br><span class="line"><span class="comment"> *  必须实现GlobalFilter，Ordered</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthGlobaFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//过滤器逻辑</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//统一鉴权</span></span><br><span class="line">        String token = exchange.getRequest().getQueryParams().getFirst(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.equals(<span class="string">&quot;admin&quot;</span>,token)) &#123;</span><br><span class="line">          log.info(<span class="string">&quot;认证失败---&quot;</span>);</span><br><span class="line">          exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">          <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//标识当前过滤器的优先级，返回值越小，优先级越高</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-7-网关限流"><a href="#5-7-网关限流" class="headerlink" title="5.7 网关限流"></a>5.7 网关限流</h2><p>网关是所有请求的公共入口，所以可以在网关进行限流，而且限流的方式也很多，我们本次采用前 面学过的Sentinel组件来实现网关的限流。Sentinel支持对SpringCloud Gateway、Zuul等主流网关进行限流。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/mysql/20220116150925.png" alt="image-20220116150918304"></p>
<p>从1.6.0版本开始，Sentinel提供了SpringCloud Gateway的适配模块，可以提供两种资源维度的限流：</p>
<ul>
<li>route维度：即在Spring配置文件中配置的路由条目，资源名为对应的touteId</li>
<li>自定义API维度：用户可以利用Sentinel提供的API来自定义一些API分组</li>
</ul>
<h5 id="1-导入依赖"><a href="#1-导入依赖" class="headerlink" title="1 导入依赖"></a>1 导入依赖</h5><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">&lt;dependency&gt;</span></span><br><span class="line">    <span class="string">&lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;</span></span><br><span class="line">    <span class="string">&lt;artifactId&gt;sentinel-spring-cloud-gateway-adapter&lt;/artifactId&gt;</span></span><br><span class="line"> <span class="string">&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="2-编写配置类"><a href="#2-编写配置类" class="headerlink" title="2 编写配置类"></a><strong>2</strong> <strong>编写配置类</strong></h5><p>基于Sentinel 的Gateway限流是通过其提供的Filter来完成的，使用时只需注入对应的SentinelGatewayFilter实例以及 SentinelGatewayBlockExceptionHandler 实例即可.</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">WB</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://hnnwb.github.io/2021/03/14/springcloudalibaba/">https://hnnwb.github.io/2021/03/14/springcloudalibaba/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://hnnwb.github.io" target="_blank">WB</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/springCloudAlibaba/">springCloudAlibaba</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/hnnwb/wbImgs/images/2fa30787e950352a94bda0385f43fbf2b3118bf6.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/myimg/wechat.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/myimg/wechat.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/myimg/alipay.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/myimg/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/06/25/java-chang-yong-gong-ju-lei/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/hnnwb/wbImgs/images/2fa30787e950352a94bda0385f43fbf2b3118bf6.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Java自带常用工具类</div></div></a></div><div class="next-post pull-right"><a href="/2021/01/25/docker-chang-yong-ming-ling/"><img class="next-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/hnnwb/wbImgs/images/2fa30787e950352a94bda0385f43fbf2b3118bf6.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">docker常用命令</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/01/14/springcloud-quan-jia-tong/" title="springCloud全家桶"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://gitee.com/hnnwb/myImg/raw/master/imgs/head/20210108211829.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-14</div><div class="title">springCloud全家桶</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Waline</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/myimg/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">WB</div><div class="author-info__description">无限开源</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/hnnwb"><i class="fab fa-github"></i><span>GitHub</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/hnnwb" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:949988739@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BB%8B%E7%BB%8D"><span class="toc-text">第一章 微服务介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%BC%94%E5%8F%98"><span class="toc-text">1.1  系统架构演变</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1-%E5%8D%95%E4%BD%93%E5%BA%94%E7%94%A8%E6%9E%B6%E6%9E%84"><span class="toc-text">1.1.1  单体应用架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E7%82%B9%EF%BC%9A"><span class="toc-text">优点：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9%EF%BC%9A"><span class="toc-text">缺点：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2-%E5%9E%82%E7%9B%B4%E5%BA%94%E7%94%A8%E6%9E%B6%E6%9E%84"><span class="toc-text">1.1.2  垂直应用架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E7%82%B9%EF%BC%9A-1"><span class="toc-text">优点：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9%EF%BC%9A-1"><span class="toc-text">缺点：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-3-%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84"><span class="toc-text">1.1.3  分布式架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E7%82%B9%EF%BC%9A-2"><span class="toc-text">优点：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9%EF%BC%9A-2"><span class="toc-text">缺点：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-4-SOA%E6%9E%B6%E6%9E%84"><span class="toc-text">1.1.4  SOA架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E7%82%B9%EF%BC%9A-3"><span class="toc-text">优点：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9%EF%BC%9A-3"><span class="toc-text">缺点：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-5-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84"><span class="toc-text">1.1.5 微服务架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E7%82%B9%EF%BC%9A-4"><span class="toc-text">优点：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9%EF%BC%9A-4"><span class="toc-text">缺点：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E4%BB%8B%E7%BB%8D"><span class="toc-text">1.2  微服务架构介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-text">1.2.1  微服务架构的常见问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E5%B8%B8%E8%A7%81%E6%A6%82%E5%BF%B5"><span class="toc-text">1.2.2  微服务架构的常见概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-1-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86"><span class="toc-text">1.2.2.1 服务治理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-2-%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="toc-text">1.2.2.2 服务调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-3-%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3"><span class="toc-text">1.2.2.3 服务网关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-4-%E6%9C%8D%E5%8A%A1%E5%AE%B9%E9%94%99"><span class="toc-text">1.2.2.4 服务容错</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-5-%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA"><span class="toc-text">1.2.2.5 链路追踪</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-3-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E5%B8%B8%E8%A7%81%E8%A7%A3%E5%86%B3%E6%96%B9"><span class="toc-text">1.2.3  微服务架构的常见解决方</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-1-ServiceComb"><span class="toc-text">1.2.3.1 ServiceComb</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-2-SpringCloud"><span class="toc-text">1.2.3.2 SpringCloud</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-3-SpringCloud-Alibaba"><span class="toc-text">1.2.3.3 SpringCloud Alibaba</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-SpringCloud-Alibaba%E4%BB%8B%E7%BB%8D"><span class="toc-text">1.3  SpringCloud Alibaba介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1-%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="toc-text">1.3.1  主要功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-2-%E7%BB%84%E4%BB%B6"><span class="toc-text">1.3.2  组件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">第二章 微服务环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%A1%88%E4%BE%8B%E5%87%86%E5%A4%87"><span class="toc-text">2.1  案例准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B"><span class="toc-text">2.1.1  技术选型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1"><span class="toc-text">2.1.2  模块设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="toc-text">2.1.3  微服务调用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E5%88%9B%E5%BB%BA%E7%88%B6%E5%B7%A5%E7%A8%8B"><span class="toc-text">2.2  创建父工程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E5%88%9B%E5%BB%BA%E5%9F%BA%E7%A1%80%E6%A8%A1%E5%9D%97"><span class="toc-text">2.3  创建基础模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-text">2.4  创建用户微服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E5%88%9B%E5%BB%BA%E5%95%86%E5%93%81%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-text">2.5  创建商品微服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-text">2.6  创建订单微服务</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0-Nacos-Discovery%E2%80%93%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86"><span class="toc-text">第三章 Nacos Discovery–服务治理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E4%BB%8B%E7%BB%8D"><span class="toc-text">3.1  服务治理介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%88%E6%9D%A5%E6%80%9D%E8%80%83%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98"><span class="toc-text">先来思考一个问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86"><span class="toc-text">什么是服务治理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-text">常见的注册中心</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-nacos%E7%AE%80%E4%BB%8B"><span class="toc-text">3.2  nacos简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-nacos%E5%AE%9E%E6%88%98%E5%85%A5%E9%97%A8"><span class="toc-text">3.3  nacos实战入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-%E6%90%AD%E5%BB%BAnacos%E7%8E%AF%E5%A2%83"><span class="toc-text">3.3.1  搭建nacos环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-%E5%B0%86%E5%95%86%E5%93%81%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%88%B0nacos"><span class="toc-text">3.3.2  将商品微服务注册到nacos</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3-%E5%B0%86%E8%AE%A2%E5%8D%95%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%88%B0nacos"><span class="toc-text">3.3.3  将订单微服务注册到nacos</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">3.4  实现服务调用的负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-%E4%BB%80%E4%B9%88%E6%98%AF%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">3.4.1  什么是负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">3.4.2  自定义实现负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-%E5%9F%BA%E4%BA%8ERibbon%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">3.4.3  基于Ribbon实现负载均衡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E5%9F%BA%E4%BA%8EFeign%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="toc-text">3.5  基于Feign实现服务调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-1-%E4%BB%80%E4%B9%88%E6%98%AFFeign"><span class="toc-text">3.5.1  什么是Feign</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-2-Feign%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">3.5.2  Feign的使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0-Sentinel%E2%80%93%E6%9C%8D%E5%8A%A1%E5%AE%B9%E9%94%99"><span class="toc-text">第四章 Sentinel–服务容错</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E9%AB%98%E5%B9%B6%E5%8F%91%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">4.1  高并发带来的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E6%9C%8D%E5%8A%A1%E9%9B%AA%E5%B4%A9%E6%95%88%E5%BA%94"><span class="toc-text">4.2  服务雪崩效应</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E5%B8%B8%E8%A7%81%E5%AE%B9%E9%94%99%E6%96%B9%E6%A1%88"><span class="toc-text">4.3  常见容错方案</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E5%AE%B9%E9%94%99%E6%80%9D%E8%B7%AF"><span class="toc-text">常见的容错思路</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E5%AE%B9%E9%94%99%E7%BB%84%E4%BB%B6"><span class="toc-text">常见的容错组件</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-Sentinel%E5%85%A5%E9%97%A8"><span class="toc-text">4.4  Sentinel入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-1-%E4%BB%80%E4%B9%88%E6%98%AFSentinel"><span class="toc-text">4.4.1  什么是Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Sentinel-%E5%85%B7%E6%9C%89%E4%BB%A5%E4%B8%8B%E7%89%B9%E5%BE%81"><span class="toc-text">Sentinel 具有以下特征:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Sentinel-%E5%88%86%E4%B8%BA%E4%B8%A4%E4%B8%AA%E9%83%A8%E5%88%86"><span class="toc-text">Sentinel 分为两个部分:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-2-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9B%86%E6%88%90Sentinel"><span class="toc-text">4.4.2  微服务集成Sentinel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-3-%E5%AE%89%E8%A3%85Sentinel%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="toc-text">4.4.3  安装Sentinel控制台</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%EF%BC%9A%E4%BA%86%E8%A7%A3%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%9A%84%E4%BD%BF%E7%94%A8%E5%8E%9F%E7%90%86"><span class="toc-text">补充：了解控制台的使用原理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-4-%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%8E%A5%E5%8F%A3%E7%9A%84%E9%99%90%E6%B5%81"><span class="toc-text">4.4.4  实现一个接口的限流</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-Sentinel%E7%9A%84%E6%A6%82%E5%BF%B5%E5%92%8C%E5%8A%9F%E8%83%BD"><span class="toc-text">4.5  Sentinel的概念和功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-1-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">4.5.1  基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-2-%E9%87%8D%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="toc-text">4.5.2  重要功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="toc-text">流量控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7"><span class="toc-text">熔断降级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%B4%9F%E8%BD%BD%E4%BF%9D%E6%8A%A4"><span class="toc-text">系统负载保护</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6-Sentinel%E8%A7%84%E5%88%99"><span class="toc-text">4.6  Sentinel规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-1-%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99"><span class="toc-text">4.6.1  流控规则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-1-1-%E7%AE%80%E5%8D%95%E9%85%8D%E7%BD%AE"><span class="toc-text">4.6.1.1 简单配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-1-2-%E9%85%8D%E7%BD%AE%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F"><span class="toc-text">4.6.1.2 配置流控模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F"><span class="toc-text">直接流控模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F"><span class="toc-text">关联流控模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%93%BE%E8%B7%AF%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F"><span class="toc-text">链路流控模式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-1-3-%E9%85%8D%E7%BD%AE%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C"><span class="toc-text">4.6.1.3 配置流控效果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-2-%E9%99%8D%E7%BA%A7%E8%A7%84%E5%88%99"><span class="toc-text">4.6.2  降级规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-3-%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99"><span class="toc-text">4.6.3  热点规则</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="toc-text">热点规则简单使用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99%E5%A2%9E%E5%BC%BA%E4%BD%BF%E7%94%A8"><span class="toc-text">热点规则增强使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-4-%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99"><span class="toc-text">4.6.4  授权规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-5-%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%99"><span class="toc-text">4.6.5  系统规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-7-SentinelResource%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">4.7  @SentinelResource的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E9%99%90%E6%B5%81%E5%92%8C%E9%99%8D%E7%BA%A7%E5%90%8E%E7%9A%84%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95"><span class="toc-text">定义限流和降级后的处理方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-8-Sentinel%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">4.8  Sentinel规则持久化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-9-Feign%E6%95%B4%E5%90%88Sentinel"><span class="toc-text">4.9  Feign整合Sentinel</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0-Gateway%E2%80%93%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3"><span class="toc-text">第五章 Gateway–服务网关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E7%BD%91%E5%85%B3%E7%AE%80%E4%BB%8B"><span class="toc-text">5.1  网关简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-Gateway%E7%AE%80%E4%BB%8B"><span class="toc-text">5.2  Gateway简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-Gateway%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-text">5.3  Gateway快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-1-%E5%9F%BA%E7%A1%80%E7%89%88"><span class="toc-text">5.3.1  基础版</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-2-%E5%A2%9E%E5%BC%BA%E7%89%88"><span class="toc-text">5.3.2  增强版</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-3-%E7%AE%80%E5%86%99%E7%89%88"><span class="toc-text">5.3.3  简写版</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-Gateway%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84"><span class="toc-text">5.4  Gateway核心架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-1%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">5.4.1基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-2-%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">5.4.2  执行流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-%E6%96%AD%E8%A8%80"><span class="toc-text">5.5  断言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-1-%E5%86%85%E7%BD%AE%E8%B7%AF%E7%94%B1%E6%96%AD%E8%A8%80%E5%B7%A5%E5%8E%82"><span class="toc-text">5.5.1  内置路由断言工厂</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E8%B7%AF%E7%94%B1%E6%96%AD%E8%A8%80%E5%B7%A5%E5%8E%82%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">内置路由断言工厂的使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B7%AF%E7%94%B1%E6%96%AD%E8%A8%80%E5%B7%A5"><span class="toc-text">5.5.2  自定义路由断言工</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-6-%E8%BF%87%E6%BB%A4"><span class="toc-text">5.6  过滤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-1-%E5%B1%80%E9%83%A8%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">5.6.1  局部过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-6-1-1-%E5%86%85%E7%BD%AE%E5%B1%80%E9%83%A8%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">5.6.1.1 内置局部过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-6-1-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B1%80%E9%83%A8%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">5.6.1.2 自定义局部过滤器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-2-%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">5.6.2  全局过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-6-2-1-%E5%86%85%E7%BD%AE%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">5.6.2.1 内置全局过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-6-2-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">5.6.2.2 自定义全局过滤器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-7-%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81"><span class="toc-text">5.7 网关限流</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">1 导入依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E7%BC%96%E5%86%99%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-text">2 编写配置类</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/02/13/rabbitmq/" title="无题"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/hnnwb/wbImgs/images/2fa30787e950352a94bda0385f43fbf2b3118bf6.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2022/02/13/rabbitmq/" title="无题">无题</a><time datetime="2022-02-13T12:00:07.642Z" title="发表于 2022-02-13 20:00:07">2022-02-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/01/03/han-shu-shi-bian-cheng/" title="无题"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/hnnwb/wbImgs/images/2fa30787e950352a94bda0385f43fbf2b3118bf6.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2022/01/03/han-shu-shi-bian-cheng/" title="无题">无题</a><time datetime="2022-01-03T10:24:19.997Z" title="发表于 2022-01-03 18:24:19">2022-01-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/08/15/mysql-xue-xi-zhi-lu/" title="mysql学习之路"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/hnnwb/wbImgs/images/2fa30787e950352a94bda0385f43fbf2b3118bf6.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="mysql学习之路"/></a><div class="content"><a class="title" href="/2021/08/15/mysql-xue-xi-zhi-lu/" title="mysql学习之路">mysql学习之路</a><time datetime="2021-08-15T08:56:43.000Z" title="发表于 2021-08-15 16:56:43">2021-08-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/06/25/java-chang-yong-gong-ju-lei/" title="Java自带常用工具类"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/hnnwb/wbImgs/images/2fa30787e950352a94bda0385f43fbf2b3118bf6.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java自带常用工具类"/></a><div class="content"><a class="title" href="/2021/06/25/java-chang-yong-gong-ju-lei/" title="Java自带常用工具类">Java自带常用工具类</a><time datetime="2021-06-25T05:25:20.000Z" title="发表于 2021-06-25 13:25:20">2021-06-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/03/14/springcloudalibaba/" title="springCloudAlibaba"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/hnnwb/wbImgs/images/2fa30787e950352a94bda0385f43fbf2b3118bf6.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="springCloudAlibaba"/></a><div class="content"><a class="title" href="/2021/03/14/springcloudalibaba/" title="springCloudAlibaba">springCloudAlibaba</a><time datetime="2021-03-14T07:51:08.000Z" title="发表于 2021-03-14 15:51:08">2021-03-14</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/hnnwb/wbImgs/images/2fa30787e950352a94bda0385f43fbf2b3118bf6.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By WB</div><div class="footer_custom_text">Hi, welcome to my <a href="https://hnnwb.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(() => {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      true && mermaid.init()
    })
  }
}</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'd7Nj0J2yTg8zaQfXuAgYQxFY-MdYXbMMI',
      appKey: 'giTKkYk81cI5xA7c9oghd1go',
      placeholder: '记得留下你的昵称和邮箱....可以快速收到回复',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadWaline () {
  function initWaline () {
    const waline = new Waline(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://blog-opal-two.vercel.app/',
      avatar: 'monsterid',
      avatarCDN: 'https://sdn.geekzu.org/avatar/',
      path: location.pathname,
      visitor: false,
      dark: 'html[data-theme="dark"]'
    }, null))
  }

  if (typeof Waline === 'function') initWaline() 
  else getScript('https://cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js').then(initWaline)
}

if ('Valine' === 'Waline' || !true) {
  if (true) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
  else setTimeout(loadWaline, 0)
} else {
  function loadOtherComment () {
    loadWaline()
  }
}</script></div><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.17.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=monsterid'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://d7Nj0J2y.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": 'd7Nj0J2yTg8zaQfXuAgYQxFY-MdYXbMMI',
        "X-LC-Key": 'giTKkYk81cI5xA7c9oghd1go',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.innerHTML= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><div class="aplayer no-destroy" data-id="647449849" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="true" muted></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/xinqing/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.removeEventListener('scroll', window.tocScrollFn)
  window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>